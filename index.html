<script>
    const $ = (s) => document.querySelector(s);
    let dbData = []; 

    // UUID ç”¢ç”Ÿå™¨ (è§£æ±º crypto.randomUUID åœ¨é HTTPS ç’°å¢ƒå ±éŒ¯çš„å•é¡Œ)
    function generateUUID() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        try { return crypto.randomUUID(); } catch(e) {}
      }
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function toggleMobileSidebar() {
      const a = $('aside');
      a.classList.toggle('hidden');
      a.classList.toggle('absolute');
      a.classList.toggle('h-full');
    }

    // åˆå§‹åŒ–æ—¥æ›†èˆ‡æ—¥æœŸ
    if($('#calendarFrame')) $('#calendarFrame').src = CALENDAR_EMBED_URL;
    if($('#date')) $('#date').value = new Date().toISOString().slice(0,10);

    const SAFETY_HIGH = "âš ï¸ ä¾å…§æ”¿éƒ¨æ¶ˆé˜²ç½²109å¹´9æœˆ29æ—¥æ¶ˆç½²è¨“å­—ç¬¬1091700957è™Ÿå‡½é ’ã€Œæ¶ˆé˜²æ©Ÿé—œè¾¦ç†å„é …æ•‘ç½è¨“ç·´å®‰å…¨ç®¡ç†æŒ‡å°åŸå‰‡ã€è¾¦ç†ï¼Œè«‹æŒ‡æ´¾è³‡æ·±æ•™å®˜è² è²¬å…¨ç›¤è¨“ç·´å®‰å…¨äº‹å®œã€‚\nâš ï¸ å€Ÿç”¨å–®ä½è«‹æ–¼è¨“å¾Œå°‡å ´åœ°å¾©åŸä¸¦ç¶­æŒå ´åœ°æ•´æ½”ã€‚";
    const SAFETY_LOW = "âš ï¸ è«‹å€Ÿç”¨å–®ä½è¨“å¾Œå°‡å ´åœ°å¾©åŸä¸¦ç¶­æŒå ´åœ°æ•´æ½”ã€‚";

    // å ´åœ°é¸æ“‡ â†’ å®‰å…¨æ–‡å­—
    $('#facility').addEventListener('change', (e) => {
      const val = e.target.value;
      const customInput = $('#customFacility');
      if(val === 'other') {
        customInput.classList.remove('hidden');
        customInput.required = true;
      } else {
        customInput.classList.add('hidden');
        customInput.required = false;
        customInput.value = ""; // æ¸…ç©ºéš±è—çš„è¼¸å…¥å€¼
      }
      const isHigh = ["ç‡ƒç‡’æ«ƒ", "ç‡ƒç‡’å®¤", "ç©ºå‘¼æ°£è¨“ç·´å ´", "ABå¡”", "å¤§ç›´è¨“ç·´å ´"].includes(val) || val === 'other';
      $('#safetyText').innerText = isHigh ? SAFETY_HIGH : SAFETY_LOW;
    });
    $('#safetyText').innerText = SAFETY_LOW;

    // å…¨å¤©å‹¾é¸
    $('#isAllDay').addEventListener('change', (e) => {
      const s = $('#startTime'), eEnd = $('#endTime');
      if(e.target.checked) {
        s.value="08:00";
        eEnd.value="17:00";
        s.classList.add('disabled-input');
        eEnd.classList.add('disabled-input');
      } else {
        s.classList.remove('disabled-input');
        eEnd.classList.remove('disabled-input');
      }
    });

    // ç”³è«‹æ¨¡å¼åˆ‡æ›ï¼šå–®æ—¥ / å¤šæ—¥
    function updateApplyMode() {
      const mode = document.querySelector('input[name="applyMode"]:checked').value;
      const singleRow = $('#singleDateRow');
      const multiWrap  = $('#multiDateWrap');
      const singleDate = $('#date');
      const dStart = $('#dateStart');
      const dEnd   = $('#dateEnd');

      if (mode === 'single') {
        singleRow.classList.remove('hidden');
        multiWrap.classList.add('hidden');
        singleDate.required = true;
        dStart.required = false;
        dEnd.required   = false;
      } else {
        singleRow.classList.add('hidden');
        multiWrap.classList.remove('hidden');
        singleDate.required = false;
        dStart.required = true;
        dEnd.required   = true;
      }
    }

    document.querySelectorAll('input[name="applyMode"]').forEach(r => {
      r.addEventListener('change', updateApplyMode);
    });

    async function fetchData() {
      try { 
        const res = await fetch(GAS_ENDPOINT); 
        dbData = await res.json(); 
        updateWeeklyNotice(); 
        renderList();
        renderTodo();
        showToast('åŒæ­¥å®Œæˆ','è³‡æ–™å·²æ›´æ–°','success'); 
      } catch(e){
        console.error(e);
        showToast('åŒæ­¥å¤±æ•—','ç„¡æ³•å–å¾—æœ€æ–°è³‡æ–™','error');
      }
    }
    $('#syncBtn').onclick = fetchData;
    fetchData();

    // Helper: åˆ¤æ–·ç¼ºå“ªäº›ç…§ç‰‡
    function getMissingParts(statusStr) {
      const missing = [];
      if (!statusStr.includes('ä½¿ç”¨å‰')) missing.push('å‰');
      if (!statusStr.includes('ä½¿ç”¨ä¸­')) missing.push('ä¸­');
      if (!statusStr.includes('æ­¸é‚„å¾Œ')) missing.push('å¾Œ');
      return missing;
    }

    // ğŸ”´ æ¸²æŸ“å¾…è£œç…§ç‰‡æé†’å€å¡Š
    function renderTodo() {
      const todoContainer = $('#todoList');
      const todoSection = $('#todoSection');
      const badge = $('#pendingBadge');
      const today = new Date().toISOString().slice(0,10);
      
      const pendingItems = dbData.filter(x => {
        if(!x.status.includes('å·²æ ¸å‡†')) return false;
        if(x.date > today) return false;
        const s = x.uploadStatus || "";
        return !(s.includes("ä½¿ç”¨å‰") && s.includes("ä½¿ç”¨ä¸­") && s.includes("æ­¸é‚„å¾Œ"));
      });

      if (pendingItems.length > 0) {
        badge.innerText = pendingItems.length;
        badge.classList.remove('hidden');
        todoSection.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
        todoSection.classList.add('hidden');
        return;
      }

      todoContainer.innerHTML = pendingItems.map(item => {
        const missing = getMissingParts(item.uploadStatus || "");
        const missingText = missing.join('ã€');
        return `
          <div class="flex items-center justify-between bg-white p-2.5 rounded-lg border border-rose-100 shadow-sm">
            <div class="flex flex-col">
              <div class="text-xs font-bold text-slate-700">${item.date} ${item.facility}</div>
              <div class="text-[10px] text-rose-600 font-bold">âŒ ç¼ºï¼š${missingText}</div>
            </div>
            <button onclick="switchView('list'); openPhotoModal('${item.id}')" class="text-xs bg-rose-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-rose-700 shadow-md btn-alert">
              <i class="ri-camera-fill"></i> ä¸Šå‚³
            </button>
          </div>
        `;
      }).join('');
    }

    function updateWeeklyNotice() {
      const con = $('#weeklyNotice');
      if(!con) return;
      con.innerHTML='';
      let has=false;
      for(let i=0;i<7;i++){
        const d=new Date();
        d.setDate(new Date().getDate()+i);
        const ds=d.toISOString().slice(0,10);
        const books=dbData.filter(x=>x.date===ds&&x.status.includes('å·²æ ¸å‡†'));
        if(books.length){
          has=true;
          con.innerHTML+=`
            <div class="text-xs border-b border-slate-100 pb-2 last:border-0">
              <div class="font-bold text-indigo-600 mb-1">${ds}</div>
              ${books.map(b=>`
                <div class="flex justify-between bg-slate-50 px-2 py-1 rounded text-slate-600">
                  <span>${b.facility}</span>
                  <span>${b.startTime}-${b.endTime}</span>
                </div>`).join('')}
            </div>`;
        }
      }
      if(!has) con.innerHTML='<div class="text-sm text-slate-400 py-4 text-center">æœªä¾† 7 å¤©ç„¡æ ¸å‡†é ç´„</div>';
    }

    // è¡¨å–®é€å‡º
    $('#bookingForm').addEventListener('submit', async e => {
      e.preventDefault();

      // æ™‚é–“é˜²å‘†
      if($('#endTime').value <= $('#startTime').value) {
        alert('æ™‚é–“éŒ¯èª¤ï¼šçµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“');
        return;
      }

      let fac = $('#facility').value;
      if(fac === 'other') fac = $('#customFacility').value.trim();
      if(!fac) {
        alert('è«‹é¸æ“‡æˆ–è¼¸å…¥å ´åœ°');
        return;
      }

      const btn = $('#submitBtn');
      // é¿å…é‡è¤‡é»æ“Š
      if(btn.disabled) return;
      const originalBtnText = btn.innerHTML;
      btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> è™•ç†ä¸­...';
      btn.disabled = true;

      try {
        const isEdit = $('#editId').value !== "";
        // æ§‹å»º Base ç‰©ä»¶ç§»åˆ° try å…§éƒ¨ï¼Œä¸¦ä½¿ç”¨è‡ªè¨‚ generateUUID
        const base = {
            unit:$('#unit').value,
            contact:$('#contact').value,
            phone:$('#phone').value,
            email:$('#email').value,
            facility:fac,
            purpose:$('#purpose').value,
            startTime:$('#startTime').value,
            endTime:$('#endTime').value,
            id: isEdit ? $('#editId').value : generateUUID()
        };

        if (isEdit) {
          await fetch(GAS_ENDPOINT, {
            method:'POST',
            headers: {"Content-Type": "text/plain"},
            body:JSON.stringify({...base, date:$('#date').value, action:'edit'})
          });
          showToast('æ›´æ–°æˆåŠŸ','å·²å„²å­˜è®Šæ›´','success');
          resetForm();
          setTimeout(fetchData, 1500);
        } else {
          // ç”³è«‹æ¨¡å¼ï¼šsingle = å–®æ—¥ã€multi = å¤šæ—¥
          const applyMode = document.querySelector('input[name="applyMode"]:checked').value;
          let dates = [];

          if (applyMode === 'single') {
            const singleDate = $('#date').value;
            if (!singleDate) throw new Error('è«‹å¡«å¯«å–®æ—¥æ—¥æœŸ');
            dates = [singleDate];
          } else {
            const dStart = $('#dateStart').value;
            const dEnd   = $('#dateEnd').value;
            const mode   = $('#dateMode').value;

            if (!dStart || !dEnd) throw new Error('è«‹å¡«å¯«å¤šæ—¥èµ·è¨–æ—¥æœŸ');
            
            const start = new Date(dStart);
            const end   = new Date(dEnd);
            if (end < start) throw new Error('å¤šæ—¥å€é–“éŒ¯èª¤ï¼šçµæŸæ—¥æœŸéœ€æ™šæ–¼èµ·å§‹æ—¥æœŸ');

            let c = new Date(start);
            while (c <= end) {
              const day = c.getDay();
              let add = true;
              if (mode === 'weekday' && (day === 0 || day === 6)) add = false;
              if (mode === 'weekend' && (day !== 0 && day !== 6)) add = false;
              if (add) dates.push(c.toISOString().slice(0,10));
              c.setDate(c.getDate() + 1);
            }
            if (!dates.length) throw new Error('å¤šæ—¥å€é–“å…§ç„¡æœ‰æ•ˆæ—¥æœŸï¼ˆå¯èƒ½å…¨éƒ¨è¢«æ’é™¤ç‚ºé€±æœ«æˆ–å¹³æ—¥ï¼‰');
          }

          // ç™¼é€è«‹æ±‚
          await fetch(GAS_ENDPOINT, {
            method:'POST',
            headers: {"Content-Type": "text/plain"},
            body:JSON.stringify({...base, dates:dates, action:'create_batch'})
          });
          showToast('ç”³è«‹æˆåŠŸ',`å·²é€å‡º ${dates.length} ç­†ç´€éŒ„ï¼Œå¾…å¯©æ ¸ã€‚`,'success');
          resetForm();
          setTimeout(fetchData, 1500);
        }
      } catch(err){
        console.error(err);
        alert('æäº¤å¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'));
        showToast('æäº¤å¤±æ•—','è«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡ç®¡ç†è€…','error');
      } finally {
        btn.innerHTML = originalBtnText;
        btn.classList.remove('bg-emerald-600'); 
        btn.classList.add('bg-slate-900');
        if($('#editId').value) {
            // å¦‚æœé‚„åœ¨ç·¨è¼¯æ¨¡å¼ä¸”å¤±æ•—ï¼Œä¿æŒç·¨è¼¯æŒ‰éˆ•æ¨£å¼
            btn.innerHTML = "<i class='ri-save-line'></i> å„²å­˜è®Šæ›´";
            btn.classList.add('bg-emerald-600');
        } else {
            btn.innerHTML = "<i class='ri-send-plane-fill'></i> æäº¤ç”³è«‹";
        }
        btn.disabled = false;
      }
    });

    // ç…§ç‰‡é è¦½
    $('#photoFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = (e) => {
          $('#photoPreview').style.backgroundImage = `url(${e.target.result})`;
          $('#photoPreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    window.openPhotoModal = (id) => {
      $('#photoTargetId').value = id;
      $('#photoFile').value = '';
      $('#photoPreview').classList.add('hidden');
      $('#progressText').classList.add('hidden');
      $('#photoModal').classList.replace('hidden', 'flex');
    };
    
    $('#photoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = $('#photoFile').files[0];
      if(!file) return alert('è«‹é¸æ“‡ç…§ç‰‡');

      const btn = $('#uploadBtn');
      btn.innerHTML = 'è™•ç†ä¸­...';
      btn.disabled = true;
      const pt = $('#progressText');
      pt.textContent='æ­£åœ¨å£“ç¸®åœ–ç‰‡...';
      pt.classList.remove('hidden');

      try {
        const resized = await compressImage(file);
        const type = document.querySelector('input[name="photoType"]:checked').value;
        pt.textContent='æ­£åœ¨ä¸Šå‚³è‡³é›²ç«¯...';

        const res = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: {"Content-Type": "text/plain"},
          body: JSON.stringify({
            action: 'upload_photo',
            id: $('#photoTargetId').value,
            fileData: resized.split(',')[1],
            mimeType: 'image/jpeg',
            photoType: type
          })
        });
        const result = await res.json();
        if(result.status === 'success') {
          showToast('ä¸Šå‚³æˆåŠŸ','ç…§ç‰‡å·²å­˜å…¥é›²ç«¯','success');
          $('#photoModal').classList.replace('flex','hidden');
          setTimeout(fetchData, 1500);
        } else {
          alert(result.message || 'ä¸Šå‚³å¤±æ•—');
        }
      } catch(err) {
        console.error(err);
        alert('ä¸Šå‚³éç¨‹ç™¼ç”ŸéŒ¯èª¤');
      } finally {
        btn.innerHTML = 'é–‹å§‹ä¸Šå‚³';
        btn.disabled = false;
        pt.classList.add('hidden');
      }
    });

    function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const scale = 800 / img.width;
            canvas.width = scale < 1 ? 800 : img.width;
            canvas.height = scale < 1 ? img.height * scale : img.height;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.6));
          };
        };
      });
    }

    window.editRecord = (id) => {
      const r = dbData.find(x => x.id === id);
      if(!r) return;
      $('#editId').value = r.id;
      $('#unit').value = r.unit;
      $('#contact').value = r.contact;
      $('#phone').value = r.phone;
      $('#email').value = r.email;
      $('#facility').value = r.facility;
      $('#purpose').value = r.purpose;
      $('#date').value = r.date;
      $('#startTime').value = r.startTime;
      $('#endTime').value = r.endTime;

      // ç·¨è¼¯ç‹€æ…‹å›ºå®šç”¨å–®æ—¥æ¨¡å¼
      $('#modeSingle').checked = true;
      $('#modeMulti').checked = false;
      updateApplyMode(); // æ‰‹å‹•è§¸ç™¼ä¸€æ¬¡ UI æ›´æ–°

      $('#formTitle').textContent = "ç·¨è¼¯é ç´„ç”³è«‹";
      $('#submitBtn').innerHTML = "<i class='ri-save-line'></i> å„²å­˜è®Šæ›´";
      $('#submitBtn').classList.remove('bg-slate-900');
      $('#submitBtn').classList.add('bg-emerald-600');
      $('#cancelEditBtn').classList.remove('hidden');
      switchView('form');
    };

    $('#cancelEditBtn').onclick = resetForm;

    function resetForm() {
      $('#bookingForm').reset();
      $('#editId').value = "";
      $('#date').value = new Date().toISOString().slice(0,10);
      $('#facility').value = "";
      $('#customFacility').classList.add('hidden');
      $('#formTitle').textContent = "æ–°å¢é ç´„ç”³è«‹";
      $('#submitBtn').innerHTML = "<i class='ri-send-plane-fill'></i> æäº¤ç”³è«‹";
      $('#submitBtn').classList.remove('bg-emerald-600');
      $('#submitBtn').classList.add('bg-slate-900');
      $('#cancelEditBtn').classList.add('hidden');
      $('#isAllDay').checked = false;
      $('#startTime').classList.remove('disabled-input');
      $('#endTime').classList.remove('disabled-input');
      $('#safetyText').innerText = SAFETY_LOW;

      // é‡è¨­æ¨¡å¼ç‚ºå–®æ—¥
      $('#modeSingle').checked = true;
      $('#modeMulti').checked = false;
      updateApplyMode(); // æ‰‹å‹•è§¸ç™¼ä¸€æ¬¡ UI æ›´æ–°
    }

    window.openCancelModal = (id, isBatch) => {
      $('#cancelTargetId').value = id;
      $('#cancelType').value = isBatch ? 'batch' : 'single';
      $('#verifyEmail').value = '';
      $('#cancelReason').value = '';
      $('#cancelModal').classList.replace('hidden','flex');
    };

    $('#cancelForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = $('#confirmCancelBtn');
      btn.innerHTML = 'é©—è­‰ä¸­...';
      btn.disabled = true;
      try {
        const res = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: {"Content-Type": "text/plain"},
          body: JSON.stringify({
            action: $('#cancelType').value==='batch'?'cancel_batch':'cancel_request',
            [$('#cancelType').value==='batch'?'batchId':'id']: $('#cancelTargetId').value,
            verifyEmail: $('#verifyEmail').value.trim(),
            reason: $('#cancelReason').value.trim()
          })
        });
        const result = await res.json();
        if (result.status === 'success') {
          showToast('å·²é€å‡º','å–æ¶ˆç”³è«‹å·²é€äº¤ç®¡ç†è€…','success');
          $('#cancelModal').classList.replace('flex','hidden');
          setTimeout(fetchData, 1500);
        } else {
          alert(result.message || 'ç”³è«‹å¤±æ•—');
        }
      } catch(err){
        console.error(err);
        showToast('éŒ¯èª¤','è«‹ç¨å¾Œå†è©¦','error');
      } finally {
        btn.innerHTML = 'é€å‡º';
        btn.disabled = false;
      }
    });

    function renderList() {
      const container = $('#bookingListContainer');
      if(!container) return;
      container.innerHTML='';
      const filter = $('#searchInput').value.toLowerCase();
      let activeList = dbData.filter(x => !x.status.includes("å–æ¶ˆ") && !x.status.includes("æ‹’çµ•"));
      activeList = activeList.filter(x => (x.unit+x.contact+x.facility).toLowerCase().includes(filter));

      const groups = {};
      activeList.forEach(item => {
        const key = item.batchId || item.id;
        if(!groups[key]) groups[key] = [];
        groups[key].push(item);
      });

      const sortedKeys = Object.keys(groups).sort((a,b) => groups[a][0].date.localeCompare(groups[b][0].date));
      if(sortedKeys.length === 0) {
        container.innerHTML='<div class="text-center text-slate-400 py-10">ç„¡è³‡æ–™</div>';
        return;
      }

      const today = new Date().toISOString().slice(0,10);

      sortedKeys.forEach(key => {
        const items = groups[key];
        const f = items[0];
        const isMulti = items.length > 1;
        const color = f.status.includes("æ ¸å‡†") ? "text-emerald-600 bg-emerald-50" :
                      (f.status.includes("æ’æœŸ") ? "text-rose-600 bg-rose-50" : "text-amber-600 bg-amber-50");
        
        let missingPhotoInfo = '';
        if(f.status.includes("æ ¸å‡†") && f.date <= today) {
          const anyMissing = items.some(item => {
            const s = item.uploadStatus || "";
            return !(s.includes("ä½¿ç”¨å‰") && s.includes("ä½¿ç”¨ä¸­") && s.includes("æ­¸é‚„å¾Œ"));
          });
          if(anyMissing) {
            const missingParts = getMissingParts(items[0].uploadStatus || ""); 
            const missingText = missingParts.join('ã€');
            missingPhotoInfo = `
              <div class="ml-2 flex items-center gap-2">
                <span class="text-xs text-rose-600 font-bold">å°šç¼º: ${missingText}</span>
                <button onclick="event.stopPropagation(); this.closest('.card-root').querySelector('.details-panel').classList.remove('hidden');" class="bg-rose-600 text-white text-xs px-2 py-1 rounded shadow btn-alert">
                  <i class="ri-camera-fill"></i>
                </button>
              </div>`;
          }
        }

        const card = document.createElement('div');
        card.className = "card-root bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden mb-3";
        card.innerHTML = `
          <div class="p-4 flex items-center justify-between cursor-pointer bg-white hover:bg-gray-50" onclick="this.nextElementSibling.classList.toggle('hidden')">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full flex items-center justify-center ${color} font-bold">
                <i class="ri-calendar-check-line"></i>
              </div>
              <div>
                <div class="font-bold text-slate-800 flex items-center gap-2">
                  ${f.unit} <span class="text-xs font-normal text-slate-500">(${f.contact})</span>
                  ${missingPhotoInfo}
                </div>
                <div class="text-xs text-slate-500 mt-0.5">
                  ${isMulti ? `<span class="bg-slate-100 px-1.5 py-0.5 rounded font-mono mr-1">å…±${items.length}å¤©</span>` : ''}
                  ${f.date} Â· ${f.facility}
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs font-bold px-2 py-1 rounded ${color}">${f.status.split(' ')[1]||f.status}</span>
              ${isMulti ? `<button onclick="event.stopPropagation(); openCancelModal('${f.batchId}', true)" class="text-rose-500 hover:bg-rose-50 p-1.5 rounded text-xs border border-rose-200"><i class="ri-close-circle-line"></i> æ•´æ‰¹å–æ¶ˆ</button>` : ''}
              <i class="ri-arrow-down-s-line text-slate-400"></i>
            </div>
          </div>
          <div class="details-panel hidden border-t border-slate-100 bg-slate-50 p-3 space-y-2">
            ${items.map(item => {
              const statusStr = item.uploadStatus || "";
              const isComplete = statusStr.includes("ä½¿ç”¨å‰") && statusStr.includes("ä½¿ç”¨ä¸­") && statusStr.includes("æ­¸é‚„å¾Œ");
              let photoBadge = '';
              let uploadBtnClass = "text-indigo-500 hover:bg-indigo-50 p-1 rounded"; 
              
              if (item.status.includes('æ ¸å‡†')) {
                if (item.date > today) photoBadge = `<span class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">æœªé–‹å§‹</span>`;
                else if (isComplete) photoBadge = `<span class="text-xs text-emerald-600 bg-emerald-100 px-1.5 py-0.5 rounded">â— å·²çµæ¡ˆ</span>`;
                else if (item.date === today) photoBadge = `<span class="text-xs text-amber-600 bg-amber-100 px-1.5 py-0.5 rounded">â— é€²è¡Œä¸­</span>`;
                else {
                  photoBadge = `<span class="text-xs text-rose-600 bg-rose-100 px-1.5 py-0.5 rounded font-bold">â— ç¼ºä»¶</span>`;
                  uploadBtnClass = "bg-rose-600 text-white p-1.5 rounded shadow btn-alert hover:bg-rose-700"; 
                }
              }

              return `
                <div class="flex flex-col gap-2 bg-white p-2 rounded border border-slate-200">
                  <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-3">
                      <span class="font-mono text-slate-600">${item.date}</span>
                      <span class="font-mono font-bold text-indigo-600">${item.startTime}-${item.endTime}</span>
                      <span class="text-slate-500 text-xs">${item.status}</span>
                      ${photoBadge}
                    </div>
                    <div class="flex gap-2 items-center">
                      ${(item.status.includes('æ ¸å‡†')) ? `<button onclick="openPhotoModal('${item.id}')" class="${uploadBtnClass}" title="ä¸Šå‚³ç…§ç‰‡"><i class="ri-camera-line text-lg"></i>${!isComplete && item.date <= today ? '<span class="text-xs ml-1">ä¸Šå‚³</span>':''}</button>` : ''}
                      ${(item.status.includes('å¾…å¯©æ ¸')||item.status.includes('æ’æœŸ')) ? `<button onclick="editRecord('${item.id}')" class="text-indigo-500 hover:bg-indigo-50 p-1 rounded"><i class="ri-edit-line"></i></button>` : ''}
                      <button onclick="openCancelModal('${item.id}', false)" class="text-rose-500 hover:bg-rose-50 p-1 rounded"><i class="ri-close-circle-line"></i></button>
                    </div>
                  </div>
                  ${item.folderUrl ? `
                    <div class="text-xs flex items-center justify-between bg-slate-50 p-1 rounded">
                      <a href="${item.folderUrl}" target="_blank" class="text-blue-500 hover:underline flex items-center gap-1">
                        <i class="ri-folder-open-line"></i> é–‹å•Ÿç…§ç‰‡è³‡æ–™å¤¾
                      </a>
                      <span class="text-slate-400 text-[10px]">${item.uploadStatus||''}</span>
                    </div>` : ''}
                </div>`;
            }).join('')}
          </div>`;
        container.appendChild(card);
      });
    }
    
    $('#searchInput').addEventListener('input', renderList);

    $('#exportCsvBtn').onclick = () => {
      if(!dbData.length) {
        alert('ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
        return;
      }
      const csv = '\ufeffç‹€æ…‹,æ—¥æœŸ,é–‹å§‹,çµæŸ,å ´åœ°,å–®ä½\n' +
        dbData.map(r=>`${r.status},${r.date},${r.startTime},${r.endTime},"${r.facility}","${r.unit}"`).join('\n');
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      a.download='Booking.csv';
      a.click();
    };

    function showToast(t,m,type){
      const o=$('#toast');
      $('#toastTitle').textContent=t;
      $('#toastMsg').textContent=m;
      $('#toastIcon').className=`text-2xl ri-${type==='success'?'checkbox-circle-fill text-emerald-400':'error-warning-fill text-rose-400'}`;
      o.classList.remove('translate-y-20','opacity-0');
      setTimeout(()=>o.classList.add('translate-y-20','opacity-0'),3000);
    }

    window.switchView=(v)=>{
      document.querySelectorAll('[id^="view-"]').forEach(e=>e.classList.add('hidden'));
      $('#view-'+v).classList.remove('hidden');
    };
  </script>
