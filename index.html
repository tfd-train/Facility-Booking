<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>å ´åœ°å€Ÿç”¨ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .input-field { width: 100%; border-radius: 0.5rem; border: 1px solid #e2e8f0; padding: 0.6rem; font-size: 0.875rem; transition: all 0.2s; } 
    .input-field:focus { border-color: #6366f1; outline: 2px solid #e0e7ff; } 
    .disabled-input { background-color: #f3f4f6; color: #9ca3af; pointer-events: none; }
    aside.absolute { bottom: 0; }
    
    /* ç´…è‰²å‘¼å¸ç‡ˆå‹•ç•« (ç”¨æ–¼å¼·èª¿ç¼ºä»¶æŒ‰éˆ•) */
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(225, 29, 72, 0); }
      100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); }
    }
    .btn-alert { animation: pulse-red 2s infinite; }

    /* === æ—¥æ›† Modal å°ˆç”¨ CSS === */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 15px 0; }
    .day-btn { padding: 8px; border: 1px solid #e2e8f0; background: white; cursor: pointer; text-align: center; border-radius: 6px; font-size: 14px; user-select: none; }
    .day-btn:hover { background-color: #f1f5f9; }
    .day-btn.active { background: #3b82f6; color: white; font-weight: bold; border-color: #2563eb; }
    .day-btn.active:hover { background-color: #2563eb; }
    .holiday-red { color: #dc2626; background-color: #fef2f2; border-color: #fee2e2; }
    .holiday-red.active { background: #dc2626; color: white; border-color: #b91c1c; }
    .weekend { background-color: #f8fafc; color: #64748b; }
  </style>

  <script>
    // âš ï¸ ç³»çµ±åˆ‡æ›é€£çµå€
    const TRAINING_FLOW_URL = "https://tfd-train.github.io/Training-Flow-Management/";
    const PORTAL_URL = "https://tfd-train.github.io/Training-Management-Platform/"; 
    const EV_SYSTEM_URL = "https://tfd-train.github.io/Electric-Vehicle/";
  </script>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex selection:bg-indigo-500 selection:text-white">

  <!-- Sidebar -->
  <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-2xl z-30 transition-all duration-300">
    <div class="p-6 border-b border-slate-800 flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center shadow-lg shadow-indigo-500/50">
        <i class="ri-building-2-fill text-white"></i>
      </div>
      <div>
        <h1 class="font-bold text-lg tracking-wide">å ´åœ°é ç´„</h1>
        <p class="text-xs text-slate-400">è¨“ç·´ä¸­å¿ƒå…§éƒ¨ç³»çµ±</p>
      </div>
    </div>
    
    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <button onclick="switchView('form'); resetForm();" class="nav-btn w-full text-left px-4 py-3 rounded-xl bg-indigo-600/20 text-indigo-300 border border-indigo-500/30 flex items-center gap-3 hover:bg-indigo-600 hover:text-white transition">
        <i class="ri-add-circle-line text-xl"></i> æ–°å¢ç”³è«‹
      </button>
      <button onclick="switchView('list')" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center justify-between transition group">
        <div class="flex items-center gap-3"><i class="ri-file-list-3-line text-xl"></i> é ç´„æ¸…å–®</div>
        <!-- ğŸ”´ Sidebar Badge -->
        <span id="pendingBadge" class="hidden bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm group-hover:bg-white group-hover:text-rose-600">0</span>
      </button>
      <button id="exportCsvBtn" class="w-full text-left px-4 py-2.5 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition text-sm mt-4">
        <i class="ri-file-excel-line"></i> åŒ¯å‡ºå ±è¡¨
      </button>
    </nav>

    <div class="p-4 border-t border-slate-800 space-y-2 bg-slate-900">
        <div class="text-[10px] text-slate-500 font-bold px-4 mb-1 uppercase tracking-wider">ç³»çµ±åˆ‡æ›</div>
        
        <!-- 1. è¨“ç·´æµè·¯ -->
        <a href="javascript:void(0)" onclick="location.href=TRAINING_FLOW_URL" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition text-sm">
            <i class="ri-flow-chart text-lg text-blue-400"></i> è¨“ç·´æµè·¯ç³»çµ±
        </a>

        <!-- 2. é›»å‹•è»Šè¨“ç·´çµ±è¨ˆ (æ–°åŠ å…¥) -->
        <a href="javascript:void(0)" onclick="location.href=EV_SYSTEM_URL" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition text-sm">
            <i class="ri-charging-pile-2-fill text-lg text-emerald-400"></i> é›»å‹•è»Šè¨“ç·´çµ±è¨ˆ
        </a>

        <!-- 3. å›æ•´åˆé¦–é  -->
        <a href="javascript:void(0)" onclick="location.href=PORTAL_URL" class="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-500 hover:text-white transition text-xs">
            <i class="ri-arrow-left-line"></i> å›æ•´åˆé¦–é 
        </a>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-100">
    <header class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center z-20">
      <h1 class="font-bold text-slate-800 flex items-center gap-2">
        <i class="ri-building-2-fill text-indigo-600"></i> å ´åœ°é ç´„
      </h1>
      <div class="flex gap-4 items-center">
        <a href="javascript:void(0)" onclick="location.href=PORTAL_URL" class="text-slate-400 hover:text-indigo-600"><i class="ri-home-4-line text-xl"></i></a>
        <button onclick="toggleMobileSidebar()" class="text-slate-600 p-2"><i class="ri-menu-line text-xl"></i></button>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
      
      <!-- View: Form -->
      <div id="view-form" class="max-w-7xl mx-auto animate-fade-in grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            
            <!-- ğŸ”´ å¾…è£œç…§ç‰‡æé†’å€å¡Š -->
            <div id="todoSection" class="hidden bg-rose-50 border border-rose-100 rounded-2xl p-5 shadow-sm relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-rose-100 rounded-full -mr-8 -mt-8 opacity-50"></div>
                <h3 class="font-bold text-rose-700 flex items-center gap-2 text-lg relative z-10">
                    <i class="ri-alarm-warning-fill"></i> å¾…è£œç…§ç‰‡æé†’
                </h3>
                <p class="text-sm text-rose-600 mb-3 relative z-10">ä»¥ä¸‹é ç´„å·²æ ¸å‡†ä½†ç…§ç‰‡æœªé½Šå…¨ï¼Œè«‹å„˜é€Ÿè™•ç†ï¼š</p>
                <div id="todoList" class="space-y-2 relative z-10 max-h-48 overflow-y-auto pr-2"></div>
            </div>

            <div class="flex justify-between items-end">
                <div>
                  <h2 id="formTitle" class="text-2xl font-bold text-slate-800">æ–°å¢é ç´„ç”³è«‹</h2>
                  <p class="text-slate-500 text-sm mt-1">è«‹è©³é–±è¦ç¯„ï¼Œé€å‡ºå¾Œç³»çµ±å°‡è‡ªå‹•å¯„ä¿¡é€šçŸ¥ã€‚</p>
                </div>
                <button id="syncBtn" class="text-sm text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg hover:bg-indigo-100 transition flex items-center gap-1">
                  <i class="ri-refresh-line"></i> é‡æ–°åŒæ­¥
                </button>
            </div>
          
            <!-- è¡¨å–®å…§å®¹ -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
                <div class="h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                <form id="bookingForm" class="p-6 md:p-8 space-y-6" novalidate>
                    <input type="hidden" id="editId">

                    <!-- åŸºæœ¬è³‡æ–™ -->
                    <div class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                          <input id="unit" type="text" class="input-field" placeholder="å€Ÿç”¨å–®ä½ *" required>
                          <input id="contact" type="text" class="input-field" placeholder="è¯çµ¡äººå§“å *" required>
                          <input id="phone" type="tel" class="input-field" placeholder="è¯çµ¡é›»è©± *" required>
                          <input id="email" type="email" class="input-field" placeholder="Email (æ¥æ”¶é€šçŸ¥ç”¨) *" required>
                        </div>
                    </div>

                    <hr class="border-slate-100">

                    <div class="space-y-4">
                        <!-- å ´åœ° -->
                        <select id="facility" class="input-field" required>
                          <option value="" disabled selected>è«‹é¸æ“‡å ´åœ°...</option>
                          <optgroup label="æ•™å­¸å€åŸŸ">
                            <option>æ•™å®¤701</option>
                            <option>æ•™å®¤702</option>
                            <option>æ•™å®¤703</option>
                          </optgroup>
                          <optgroup label="å¯¦é«”è¨“ç·´å ´">
                            <option>ç©ºå‘¼æ°£è¨“ç·´å ´</option>
                            <option>ç‡ƒç‡’æ«ƒ</option>
                            <option>ç‡ƒç‡’å®¤</option>
                            <option>å¤§ç›´è¨“ç·´å ´</option>
                            <option>ABå¡”</option>
                          </optgroup>
                          <option value="other">âœï¸ å…¶ä»– (è‡ªå¡«)</option>
                        </select>
                        <input id="customFacility" type="text" class="input-field hidden" placeholder="è«‹è¼¸å…¥å ´åœ°åç¨±...">

                        <!-- ç”³è«‹æ¨¡å¼åˆ‡æ› -->
                        <div class="flex flex-wrap items-center gap-3 mb-2">
                          <span class="text-xs text-slate-500 font-bold">ç”³è«‹æ¨¡å¼ï¼š</span>
                          <label class="flex items-center gap-1 text-xs cursor-pointer">
                            <input type="radio" name="applyMode" id="modeSingle" value="single" checked class="w-3 h-3 text-indigo-600">
                            <span>å–®æ—¥ç”³è«‹</span>
                          </label>
                          <label class="flex items-center gap-1 text-xs cursor-pointer">
                            <input type="radio" name="applyMode" id="modeMulti" value="multi" class="w-3 h-3 text-indigo-600">
                            <span>å¤šæ—¥ / ä¸é€£çºŒç”³è«‹</span>
                          </label>
                        </div>

                        <!-- 1. å–®æ—¥æ—¥æœŸ -->
                        <div id="singleDateContainer" class="space-y-1">
                          <label class="text-xs text-slate-500 font-bold">å€Ÿç”¨æ—¥æœŸ</label>
                          <input id="date" type="date" class="input-field" required>
                        </div>

                        <!-- 2. å¤šæ—¥/ä¸é€£çºŒæ—¥æœŸç”³è«‹å€å¡Š (è³¼ç‰©è»Šæ¨¡å¼) -->
                        <div id="multiDateWrap" class="mt-3 hidden">
                          <div class="bg-slate-50 rounded-xl border border-slate-200 p-4 space-y-3">
                            
                            <!-- é¸æ—¥æœŸå·¥å…· -->
                            <div class="flex gap-2 items-end">
                              <div class="flex-1">
                                <label class="text-[10px] text-slate-400 font-bold">é¸æ“‡æ—¥æœŸ (å¯æŒ‘é¸ä¸é€£çºŒæ—¥æœŸ)</label>
                                <input id="datePicker" type="date" class="input-field text-sm p-2">
                              </div>
                              <button type="button" onclick="addDateToList()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-indigo-700 active:scale-95 transition">
                                <i class="ri-add-line"></i> åŠ å…¥
                              </button>
                            </div>

                            <!-- å·²é¸æ—¥æœŸæ¸…å–® (æ¨™ç±¤é¡¯ç¤ºå€) -->
                            <div class="min-h-[60px] bg-white border border-slate-200 rounded-lg p-2">
                              <p id="emptyDateMsg" class="text-xs text-slate-400 text-center py-4">å°šæœªåŠ å…¥ä»»ä½•æ—¥æœŸ</p>
                              <div id="dateTagContainer" class="flex flex-wrap gap-2">
                                <!-- é€™è£¡æœƒå‹•æ…‹ç”¢ç”Ÿæ—¥æœŸæ¨™ç±¤ -->
                              </div>
                            </div>
                            
                            <p class="text-[10px] text-slate-400">
                              è«‹é€ä¸€åŠ å…¥æ¬²å€Ÿç”¨çš„æ—¥æœŸï¼Œæ”¯æ´ä¸é€£çºŒæ—¥æœŸï¼ˆä¾‹å¦‚ 1/1, 1/3, 1/5ï¼‰ã€‚
                            </p>
                          </div>
                        </div>

                        <!-- 3. æ™‚é–“æ¬„ä½ (ç¨ç«‹å‡ºä¾†ï¼Œæ°¸é é¡¯ç¤ºï¼Œè§£æ±ºæ—¥æ›†ç©ºç™½å•é¡Œ) -->
                        <div id="timeRow" class="space-y-2 mt-4 border-t border-slate-100 pt-4">
                          <div class="flex items-center gap-2 p-1 bg-slate-50 rounded border border-slate-200 w-fit">
                            <input type="checkbox" id="isAllDay" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer">
                            <label for="isAllDay" class="text-sm text-slate-700 font-medium cursor-pointer select-none">å…¨å¤©å€Ÿç”¨ (08:00 - 17:00)</label>
                          </div>
                          <div class="grid grid-cols-2 gap-4">
                            <div>
                              <label class="text-xs text-slate-500 font-bold">é–‹å§‹æ™‚é–“</label>
                              <input id="startTime" type="time" class="input-field" required>
                            </div>
                            <div>
                              <label class="text-xs text-slate-500 font-bold">çµæŸæ™‚é–“</label>
                              <input id="endTime" type="time" class="input-field" required>
                            </div>
                          </div>
                        </div>

                        <textarea id="purpose" rows="3" class="input-field" placeholder="ç”¨é€”èªªæ˜..."></textarea>
                    </div>

                    <div class="bg-rose-50 border border-rose-200 rounded-xl p-4">
                        <p id="safetyText" class="text-xs text-rose-600 mb-3 leading-relaxed">è«‹å…ˆé¸æ“‡å ´åœ°...</p>
                        <label class="flex items-start gap-2 cursor-pointer">
                          <input type="checkbox" id="safetyCheck" class="mt-1 w-4 h-4 text-rose-600 rounded" required>
                          <span class="text-xs text-rose-800 font-medium">æˆ‘å·²è©³é–±ä¸¦åŒæ„ä¸Šè¿°è¦ç¯„ã€‚</span>
                        </label>
                    </div>

                    <div class="flex gap-2">
                        <button type="button" id="cancelEditBtn" class="hidden w-1/3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200">å–æ¶ˆ</button>
                        <button type="submit" id="submitBtn" class="w-full rounded-xl bg-slate-900 text-white py-3.5 text-sm font-bold shadow-lg hover:bg-indigo-600 transition-all">
                          <i class="ri-send-plane-fill"></i> æäº¤ç”³è«‹
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="space-y-6">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
            <h3 class="font-bold text-slate-700 mb-3 text-sm uppercase tracking-wider">
              <i class="ri-calendar-2-line text-indigo-500"></i> æœªä¾† 7 å¤©æ¦‚æ³
            </h3>
            <div id="weeklyNotice" class="space-y-3 max-h-[200px] overflow-y-auto pr-1"></div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-1 overflow-hidden">
            <iframe id="calendarFrame" src="" style="border:0" width="100%" height="400" frameborder="0" scrolling="no"></iframe>
          </div>
        </div>
      </div>

      <!-- View: List -->
      <div id="view-list" class="max-w-6xl mx-auto hidden animate-fade-in">
         <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-[85vh]">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50/50">
               <h2 class="font-bold text-lg text-slate-700 flex items-center gap-2">
                 <i class="ri-file-list-3-line text-indigo-500"></i> é ç´„ç¸½è¡¨
               </h2>
               <input id="searchInput" type="text" placeholder="æœå°‹..." class="input-field py-1.5 text-sm w-40">
            </div>
            <div class="flex-1 overflow-auto p-4" id="bookingListContainer"></div>
         </div>
      </div>
    </div>
  </main>

  <!-- æ—¥æ›† Modal -->
  <div id="dateModal" class="fixed inset-0 bg-black/50 hidden z-[2000] justify-center items-center backdrop-blur-sm">
    <div class="bg-white w-[90%] max-w-[420px] p-6 rounded-2xl shadow-2xl animate-fade-in">
        <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold text-lg text-slate-800">é¸æ“‡æ—¥æœŸ</h3>
            <select id="pickerYearSelect" onchange="changePickerYear(this.value)" class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded p-1 font-bold">
                <option value="2025">2025å¹´</option>
                <option value="2026">2026å¹´</option>
                <option value="2027">2027å¹´</option>
            </select>
        </div>
        <div id="modalRangeText" class="text-sm text-indigo-600 mb-3 font-mono font-bold"></div>
        <div class="flex flex-wrap gap-2 mb-4">
            <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100" onclick="applyDateFilter('all')">å…¨é¸ç•¶æœˆ</button>
            <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100" onclick="applyDateFilter('no-weekend')">æ’é™¤å…­æ—¥</button>
            <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100" onclick="applyDateFilter('only-weekend')">åƒ…é¸å…­æ—¥</button>
            <button class="px-3 py-1.5 text-xs font-bold border rounded-lg hover:bg-slate-100 text-red-500 border-red-200" onclick="applyDateFilter('clear')">æ¸…é™¤ç•¶æœˆ</button>
        </div>
        
        <div class="calendar-grid" id="calendarGrid"></div>
        
        <div class="flex justify-end gap-2 mt-6">
            <button class="px-5 py-2 text-slate-500 hover:bg-slate-100 rounded-xl font-bold" onclick="closeDateModal()">å–æ¶ˆ</button>
            <button class="px-5 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 font-bold shadow-lg" onclick="saveDateModal()">ç¢ºå®šé¸å–</button>
        </div>
    </div>
  </div>

  <!-- å…¶ä»– Modals -->
  <div id="cancelModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
      <h3 class="text-lg font-bold text-slate-800 mb-2">èº«åˆ†é©—è­‰</h3>
      <form id="cancelForm" class="space-y-3">
        <input type="hidden" id="cancelTargetId"><input type="hidden" id="cancelType">
        <input type="email" id="verifyEmail" class="input-field" placeholder="Email" required>
        <textarea id="cancelReason" class="input-field" rows="2" placeholder="å–æ¶ˆåŸå› " required></textarea>
        <div class="flex gap-2 pt-2">
          <button type="button" onclick="$('#cancelModal').classList.replace('flex','hidden')" class="flex-1 py-2 bg-gray-100 rounded-xl">é—œé–‰</button>
          <button type="submit" id="confirmCancelBtn" class="flex-1 py-2 bg-rose-600 text-white rounded-xl">é€å‡º</button>
        </div>
      </form>
    </div>
  </div>

  <div id="photoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
      <h3 class="text-lg font-bold text-slate-800 mb-2">ä¸Šå‚³ç´€éŒ„ç…§ç‰‡</h3>
      <form id="photoForm" class="space-y-4">
        <input type="hidden" id="photoTargetId">
        <div class="grid grid-cols-3 gap-2">
          <label class="cursor-pointer border-2 border-slate-100 rounded-lg p-2 text-center hover:border-indigo-500 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
            <input type="radio" name="photoType" value="ä½¿ç”¨å‰" class="hidden" checked><div class="text-xs font-bold">ä½¿ç”¨å‰</div>
          </label>
          <label class="cursor-pointer border-2 border-slate-100 rounded-lg p-2 text-center hover:border-indigo-500 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
            <input type="radio" name="photoType" value="ä½¿ç”¨ä¸­" class="hidden"><div class="text-xs font-bold">ä½¿ç”¨ä¸­</div>
          </label>
          <label class="cursor-pointer border-2 border-slate-100 rounded-lg p-2 text-center hover:border-indigo-500 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
            <input type="radio" name="photoType" value="æ­¸é‚„å¾Œ" class="hidden"><div class="text-xs font-bold">æ­¸é‚„å¾Œ</div>
          </label>
        </div>
        <input type="file" id="photoFile" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" required>
        <div id="photoPreview" class="w-full h-32 bg-slate-100 rounded-lg hidden bg-cover bg-center"></div>
        <div id="progressText" class="text-xs text-center text-indigo-600 hidden"></div>
        <button type="submit" id="uploadBtn" class="w-full py-2.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700">é–‹å§‹ä¸Šå‚³</button>
      </form>
      <button onclick="$('#photoModal').classList.replace('flex','hidden')" class="mt-2 w-full py-2 text-slate-400 text-sm hover:text-slate-600">å–æ¶ˆ</button>
    </div>
  </div>

  <div id="toast" class="fixed bottom-8 right-8 px-6 py-4 bg-slate-800 text-white rounded-xl shadow-2xl flex items-center gap-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
    <div id="toastIcon"></div>
    <div><h4 id="toastTitle" class="font-bold text-sm"></h4><p id="toastMsg" class="text-xs text-slate-300"></p></div>
  </div>

<script>
  // ==================== å…¨åŸŸè¨­å®š ====================
  const $ = (s) => document.querySelector(s);
  let dbData = [];

  // âš ï¸ â˜… å¡«å…¥ä½ çš„ Apps Script Web App URL â˜…
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzCBtn4fcFB_QxQhObpNIzmbRyfR7qSWqkxKAfrSuLeBm3n2mP4ywPEaYd76c2-m58Z3Q/exec';
  
  // â˜… å¡«å…¥ä½ çš„ Google æ—¥æ›† embed URL
  const CALENDAR_EMBED_URL = 'https://calendar.google.com/calendar/embed?src=5d3470b8ffb11daa8db6817414d5eedacc728c0cde687d295a3b29e5e82214d1%40group.calendar.google.com&ctz=Asia%2FTaipei';

  // å…§å»ºå‡æ—¥è¡¨ (åƒè€ƒç”¨)
  const builtInHolidays = {
    '2025-1-1':true, '2025-1-25':true, '2025-1-26':true, '2025-1-27':true, '2025-1-28':true, '2025-1-29':true, '2025-1-30':true, '2025-1-31':true, '2025-2-1':true, '2025-2-2':true, '2025-2-28':true, '2025-4-3':true, '2025-4-4':true, '2025-4-5':true, '2025-4-6':true, '2025-5-30':true, '2025-5-31':true, '2025-6-1':true, '2025-10-4':true, '2025-10-5':true, '2025-10-6':true, '2025-10-10':true, '2025-10-11':true, '2025-10-12':true
  };

  // ==================== UUID ====================
  function generateUUID() {
    if (typeof crypto !== 'undefined' && crypto.randomUUID) { try { return crypto.randomUUID(); } catch(e) {} }
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  // ==================== åˆå§‹åŒ– ====================
  function toggleMobileSidebar() {
    const a = $('aside');
    if (!a) return;
    a.classList.toggle('hidden');
    a.classList.toggle('absolute');
    a.classList.toggle('h-full');
  }

  if ($('#calendarFrame')) $('#calendarFrame').src = CALENDAR_EMBED_URL;
  if ($('#date')) $('#date').value = new Date().toISOString().slice(0, 10);

  const SAFETY_HIGH = "âš ï¸ ä¾å…§æ”¿éƒ¨æ¶ˆé˜²ç½²109å¹´9æœˆ29æ—¥æ¶ˆç½²è¨“å­—ç¬¬1091700957è™Ÿå‡½é ’ã€Œæ¶ˆé˜²æ©Ÿé—œè¾¦ç†å„é …æ•‘ç½è¨“ç·´å®‰å…¨ç®¡ç†æŒ‡å°åŸå‰‡ã€è¾¦ç†ï¼Œè«‹æŒ‡æ´¾è³‡æ·±æ•™å®˜è² è²¬å…¨ç›¤è¨“ç·´å®‰å…¨äº‹å®œã€‚\nâš ï¸ å€Ÿç”¨å–®ä½è«‹æ–¼è¨“å¾Œå°‡å ´åœ°å¾©åŸä¸¦ç¶­æŒå ´åœ°æ•´æ½”ã€‚";
  const SAFETY_LOW = "âš ï¸ è«‹å€Ÿç”¨å–®ä½è¨“å¾Œå°‡å ´åœ°å¾©åŸä¸¦ç¶­æŒå ´åœ°æ•´æ½”ã€‚";

  // å ´åœ°å®‰å…¨æ–‡å­—
  const facilityEl = $('#facility');
  if (facilityEl) {
    facilityEl.addEventListener('change', (e) => {
      const val = e.target.value;
      const customInput = $('#customFacility');
      if (customInput) {
        if (val === 'other') { customInput.classList.remove('hidden'); customInput.required = true; } 
        else { customInput.classList.add('hidden'); customInput.required = false; customInput.value = ""; }
      }
      const isHigh = ["ç‡ƒç‡’æ«ƒ", "ç‡ƒç‡’å®¤", "ç©ºå‘¼æ°£è¨“ç·´å ´", "ABå¡”", "å¤§ç›´è¨“ç·´å ´"].includes(val) || val === 'other';
      const safetyTextEl = $('#safetyText');
      if (safetyTextEl) safetyTextEl.innerText = isHigh ? SAFETY_HIGH : SAFETY_LOW;
    });
  }
  if ($('#safetyText')) $('#safetyText').innerText = SAFETY_LOW;

  // å…¨å¤©å‹¾é¸
  const isAllDayEl = $('#isAllDay');
  if (isAllDayEl) {
    isAllDayEl.addEventListener('change', (e) => {
      const s = $('#startTime'), eEnd = $('#endTime');
      if (!s || !eEnd) return;
      if (e.target.checked) {
        s.value = "08:00"; eEnd.value = "17:00";
        s.classList.add('disabled-input'); eEnd.classList.add('disabled-input');
      } else {
        s.classList.remove('disabled-input'); eEnd.classList.remove('disabled-input');
      }
    });
  }

  // ç”³è«‹æ¨¡å¼åˆ‡æ›
  function updateApplyMode() {
    const modeInput = document.querySelector('input[name="applyMode"]:checked');
    const mode = modeInput ? modeInput.value : 'single';
    
    const singleContainer = $('#singleDateContainer');
    const multiWrap = $('#multiDateWrap');
    const singleDate = $('#date');

    if (!singleContainer || !multiWrap) return;

    if (mode === 'single') {
      singleContainer.classList.remove('hidden');
      multiWrap.classList.add('hidden');
      if (singleDate) singleDate.required = true;
    } else {
      singleContainer.classList.add('hidden');
      multiWrap.classList.remove('hidden');
      if (singleDate) singleDate.required = false;
    }
  }

  document.querySelectorAll('input[name="applyMode"]').forEach(r => r.addEventListener('change', updateApplyMode));
  updateApplyMode();

  // ==================== æ—¥æ›†é¸æ“‡å™¨é‚è¼¯ (ç§»æ¤ç‰ˆ) ====================
  let pickerYear = new Date().getFullYear();
  let currentCalendarMonth = new Date().getMonth() + 1;
  let selectedDatesSet = new Set(); // å­˜ "2025-1-1" æ ¼å¼
  let finalSelectedDates = [];      // å­˜ "2025-01-01" æ ¼å¼ (é€å‡ºç”¨)

  function openDateModal() {
    const modal = $('#dateModal');
    if(!modal) return;
    // é‡ç½®é¸å–ç‹€æ…‹
    if(finalSelectedDates.length > 0) {
        // å¦‚æœå·²ç¶“æœ‰é¸éçš„ï¼Œå˜—è©¦é‚„åŸ
        // é€™è£¡ç°¡åŒ–è™•ç†ï¼šæ¯æ¬¡æ‰“é–‹éƒ½æ¸…ç©ºï¼Œæˆ–è€…ä¿ç•™ä¸Šæ¬¡çš„ Set
    }
    renderCalendar();
    updateModalRangeText();
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeDateModal() {
    const modal = $('#dateModal');
    if(!modal) return;
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function changePickerYear(val) {
    pickerYear = parseInt(val);
    selectedDatesSet.clear();
    renderCalendar();
    updateModalRangeText();
  }

  function isDayOff(year, month, day) {
    const key = `${year}-${month}-${day}`;
    if (builtInHolidays[key]) return true;
    const d = new Date(year, month - 1, day);
    const w = d.getDay();
    return w === 0 || w === 6;
  }

  function renderCalendar() {
    const grid = $('#calendarGrid');
    if(!grid) return;
    grid.innerHTML = '';
    
    const header = document.createElement('div');
    header.className = "col-span-7 flex justify-between items-center mb-2";
    header.innerHTML = `
        <button type="button" onclick="changeMonth(-1)" class="px-2 py-1 bg-slate-100 rounded hover:bg-slate-200"><i class="ri-arrow-left-s-line"></i></button>
        <span class="font-bold text-lg text-indigo-600">${currentCalendarMonth} æœˆ</span>
        <button type="button" onclick="changeMonth(1)" class="px-2 py-1 bg-slate-100 rounded hover:bg-slate-200"><i class="ri-arrow-right-s-line"></i></button>
    `;
    grid.appendChild(header);

    ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].forEach(d => {
        const div = document.createElement('div');
        div.className = "text-center text-xs font-bold text-slate-500 py-1";
        div.innerText = d;
        grid.appendChild(div);
    });
    
    const daysInMonth = new Date(pickerYear, currentCalendarMonth, 0).getDate();
    const firstDay = new Date(pickerYear, currentCalendarMonth - 1, 1).getDay();

    for (let i = 0; i < firstDay; i++) { grid.appendChild(document.createElement('div')); }

    for (let d = 1; d <= daysInMonth; d++) {
        const key = `${pickerYear}-${currentCalendarMonth}-${d}`;
        const isActive = selectedDatesSet.has(key);
        const isHoliday = isDayOff(pickerYear, currentCalendarMonth, d);
        
        let extraClass = '';
        if (isHoliday) {
             // åœ‹å®šå‡æ—¥æˆ–é€±æœ«ï¼Œçµ¦ä¸åŒæ¨£å¼
             extraClass = builtInHolidays[`${pickerYear}-${currentCalendarMonth}-${d}`] ? 'holiday-red' : 'weekend';
        }

        const btn = document.createElement('div');
        btn.className = `day-btn ${isActive ? 'active' : ''} ${extraClass}`;
        btn.innerText = d;
        btn.onclick = () => { 
            if (selectedDatesSet.has(key)) selectedDatesSet.delete(key); 
            else selectedDatesSet.add(key); 
            renderCalendar(); 
            updateModalRangeText(); 
        };
        grid.appendChild(btn);
    }
  }

  function changeMonth(delta) {
    currentCalendarMonth += delta;
    if (currentCalendarMonth < 1) { currentCalendarMonth = 12; pickerYear--; }
    if (currentCalendarMonth > 12) { currentCalendarMonth = 1; pickerYear++; }
    $('#pickerYearSelect').value = pickerYear;
    renderCalendar();
    updateModalRangeText();
  }

  function updateModalRangeText() {
    $('#modalRangeText').innerText = `å·²é¸å– ${selectedDatesSet.size} å¤©`;
  }

  function applyDateFilter(type) {
    const daysInMonth = new Date(pickerYear, currentCalendarMonth, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
        const key = `${pickerYear}-${currentCalendarMonth}-${d}`;
        const isHoliday = isDayOff(pickerYear, currentCalendarMonth, d);
        if (type === 'all') selectedDatesSet.add(key);
        else if (type === 'clear') selectedDatesSet.delete(key);
        else if (type === 'no-weekend') { if (!isHoliday) selectedDatesSet.add(key); else selectedDatesSet.delete(key); }
        else if (type === 'only-weekend') { if (isHoliday) selectedDatesSet.add(key); else selectedDatesSet.delete(key); }
    }
    renderCalendar();
    updateModalRangeText();
  }

  function saveDateModal() {
    // å°‡ Set è½‰æ›ç‚ºæ ¼å¼åŒ–é™£åˆ—ä¸¦æ’åº
    finalSelectedDates = Array.from(selectedDatesSet).map(s => {
        const [y, m, d] = s.split('-').map(Number);
        const mm = m < 10 ? '0'+m : m;
        const dd = d < 10 ? '0'+d : d;
        return `${y}-${mm}-${dd}`;
    }).sort();

    renderDateTags();
    closeDateModal();
  }

  function renderDateTags() {
    const container = $('#dateTagContainer');
    const msg = $('#emptyDateMsg');
    container.innerHTML = '';
    
    if (finalSelectedDates.length === 0) {
        msg.classList.remove('hidden');
    } else {
        msg.classList.add('hidden');
        finalSelectedDates.forEach(dateStr => {
            const tag = document.createElement('div');
            tag.className = 'bg-indigo-50 text-indigo-700 text-xs font-bold px-2 py-1 rounded border border-indigo-200 flex items-center gap-2';
            tag.innerHTML = `<span>${dateStr}</span>`; 
            container.appendChild(tag);
        });
    }
  }

  // ==================== è³‡æ–™èˆ‡è¡¨å–® ====================
  async function fetchData() {
    try {
      const res = await fetch(GAS_ENDPOINT);
      dbData = await res.json();
      updateWeeklyNotice();
      renderList();
      renderTodo();
      showToast('åŒæ­¥å®Œæˆ', 'è³‡æ–™å·²æ›´æ–°', 'success');
    } catch (e) {
      console.error(e);
      showToast('åŒæ­¥å¤±æ•—', 'ç„¡æ³•å–å¾—æœ€æ–°è³‡æ–™', 'error');
    }
  }
  $('#syncBtn').onclick = fetchData;
  fetchData();

  function getMissingParts(statusStr) {
    const missing = [];
    if (!statusStr.includes('ä½¿ç”¨å‰')) missing.push('å‰');
    if (!statusStr.includes('ä½¿ç”¨ä¸­')) missing.push('ä¸­');
    if (!statusStr.includes('æ­¸é‚„å¾Œ')) missing.push('å¾Œ');
    return missing;
  }

  function renderTodo() {
    const todoContainer = $('#todoList');
    const todoSection = $('#todoSection');
    const badge = $('#pendingBadge');
    if (!todoContainer) return;

    const today = new Date().toISOString().slice(0, 10);
    const pendingItems = dbData.filter(x => {
      if (!x.status.includes('å·²æ ¸å‡†')) return false;
      if (x.date > today) return false;
      const s = x.uploadStatus || "";
      return !(s.includes("ä½¿ç”¨å‰") && s.includes("ä½¿ç”¨ä¸­") && s.includes("æ­¸é‚„å¾Œ"));
    });

    if (pendingItems.length > 0) {
      badge.innerText = pendingItems.length;
      badge.classList.remove('hidden');
      todoSection.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
      todoSection.classList.add('hidden');
      return;
    }

    todoContainer.innerHTML = pendingItems.map(item => {
      const missing = getMissingParts(item.uploadStatus || "");
      return `
        <div class="flex items-center justify-between bg-white p-2.5 rounded-lg border border-rose-100 shadow-sm">
          <div class="flex flex-col">
            <div class="text-xs font-bold text-slate-700">${item.date} ${item.facility}</div>
            <div class="text-[10px] text-rose-600 font-bold">âŒ ç¼ºï¼š${missing.join('ã€')}</div>
          </div>
          <button onclick="switchView('list'); openPhotoModal('${item.id}')" class="text-xs bg-rose-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-rose-700 shadow-md btn-alert"><i class="ri-camera-fill"></i> ä¸Šå‚³</button>
        </div>`;
    }).join('');
  }

  function updateWeeklyNotice() {
    const con = $('#weeklyNotice');
    if (!con) return;
    con.innerHTML = '';
    let has = false;
    for (let i = 0; i < 7; i++) {
      const d = new Date(); d.setDate(new Date().getDate() + i);
      const ds = d.toISOString().slice(0, 10);
      const books = dbData.filter(x => x.date === ds && x.status.includes('å·²æ ¸å‡†'));
      if (books.length) {
        has = true;
        con.innerHTML += `
          <div class="text-xs border-b border-slate-100 pb-2 last:border-0">
            <div class="font-bold text-indigo-600 mb-1">${ds}</div>
            ${books.map(b => `<div class="flex justify-between bg-slate-50 px-2 py-1 rounded text-slate-600"><span>${b.facility}</span><span>${b.startTime}-${b.endTime}</span></div>`).join('')}
          </div>`;
      }
    }
    if (!has) con.innerHTML = '<div class="text-sm text-slate-400 py-4 text-center">æœªä¾† 7 å¤©ç„¡æ ¸å‡†é ç´„</div>';
  }

  const bookingForm = $('#bookingForm');
  if (bookingForm) {
    bookingForm.addEventListener('submit', async e => {
      e.preventDefault();
      const sTime = $('#startTime').value;
      const eTime = $('#endTime').value;
      if (sTime && eTime && eTime <= sTime) { alert('æ™‚é–“éŒ¯èª¤ï¼šçµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“'); return; }

      let facVal = $('#facility').value;
      if (facVal === 'other') facVal = $('#customFacility').value.trim();
      if (!facVal) { alert('è«‹é¸æ“‡æˆ–è¼¸å…¥å ´åœ°'); return; }

      const btn = $('#submitBtn');
      if (btn.disabled) return;
      const originalBtnText = btn.innerHTML;
      btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> è™•ç†ä¸­...';
      btn.disabled = true;

      try {
        const isEdit = $('#editId').value !== "";
        const base = {
          unit: $('#unit').value, contact: $('#contact').value, phone: $('#phone').value, email: $('#email').value,
          facility: facVal, purpose: $('#purpose').value, startTime: sTime, endTime: eTime,
          id: isEdit ? $('#editId').value : generateUUID()
        };

        if (isEdit) {
          await fetch(GAS_ENDPOINT, { method: 'POST', headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ ...base, date: $('#date').value, action: 'edit' }) });
          showToast('æ›´æ–°æˆåŠŸ', 'å·²å„²å­˜è®Šæ›´', 'success');
          resetForm(); setTimeout(fetchData, 1500);
        } else {
          const applyMode = document.querySelector('input[name="applyMode"]:checked').value;
          let dates = [];
          if (applyMode === 'single') {
            if (!$('#date').value) throw new Error('è«‹å¡«å¯«å–®æ—¥æ—¥æœŸ');
            dates = [$('#date').value];
          } else {
            if (finalSelectedDates.length === 0) { alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ—¥æœŸ'); throw new Error('æœªé¸æ“‡æ—¥æœŸ'); }
            dates = [...finalSelectedDates];
          }

          await fetch(GAS_ENDPOINT, { method: 'POST', headers: { "Content-Type": "text/plain" }, body: JSON.stringify({ ...base, dates: dates, action: 'create_batch' }) });
          showToast('ç”³è«‹æˆåŠŸ', `å·²é€å‡º ${dates.length} ç­†ç´€éŒ„ï¼Œå¾…å¯©æ ¸ã€‚`, 'success');
          resetForm(); setTimeout(fetchData, 1500);
        }
      } catch (err) {
        console.error(err);
        if (err.message !== 'æœªé¸æ“‡æ—¥æœŸ') { alert('æäº¤å¤±æ•—'); showToast('æäº¤å¤±æ•—', 'è«‹ç¨å¾Œå†è©¦', 'error'); }
      } finally {
        btn.innerHTML = originalBtnText; btn.classList.remove('bg-emerald-600'); btn.classList.add('bg-slate-900');
        if ($('#editId').value) { btn.innerHTML = "<i class='ri-save-line'></i> å„²å­˜è®Šæ›´"; btn.classList.add('bg-emerald-600'); } else { btn.innerHTML = "<i class='ri-send-plane-fill'></i> æäº¤ç”³è«‹"; }
        btn.disabled = false;
      }
    });
  }

  // === ç…§ç‰‡ä¸Šå‚³ ===
  $('#photoFile').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(file){ const reader = new FileReader(); reader.onload = (e2) => { $('#photoPreview').style.backgroundImage = `url(${e2.target.result})`; $('#photoPreview').classList.remove('hidden'); }; reader.readAsDataURL(file); }
  });

  window.openPhotoModal = (id) => {
    $('#photoTargetId').value = id; $('#photoFile').value = ''; $('#photoPreview').classList.add('hidden'); $('#progressText').classList.add('hidden'); $('#photoModal').classList.replace('hidden', 'flex');
  };

  $('#photoForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const file = $('#photoFile').files[0]; if(!file) return alert('è«‹é¸æ“‡ç…§ç‰‡');
    const btn = $('#uploadBtn'); btn.innerHTML = 'è™•ç†ä¸­...'; btn.disabled = true;
    $('#progressText').textContent = 'ä¸Šå‚³ä¸­...'; $('#progressText').classList.remove('hidden');

    try {
        const resized = await compressImage(file);
        const type = document.querySelector('input[name="photoType"]:checked').value;
        const res = await fetch(GAS_ENDPOINT, { method: 'POST', headers: {"Content-Type": "text/plain"}, body: JSON.stringify({ action: 'upload_photo', id: $('#photoTargetId').value, fileData: resized.split(',')[1], mimeType: 'image/jpeg', photoType: type }) });
        const result = await res.json();
        if(result.status === 'success') { showToast('ä¸Šå‚³æˆåŠŸ', 'ç…§ç‰‡å·²å­˜å…¥é›²ç«¯', 'success'); $('#photoModal').classList.replace('flex', 'hidden'); setTimeout(fetchData, 1500); }
        else alert(result.message || 'ä¸Šå‚³å¤±æ•—');
    } catch(err) { alert('ä¸Šå‚³éŒ¯èª¤'); } finally { btn.innerHTML = 'é–‹å§‹ä¸Šå‚³'; btn.disabled = false; $('#progressText').classList.add('hidden'); }
  });

  function compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                const scale = 800 / img.width; canvas.width = scale < 1 ? 800 : img.width; canvas.height = scale < 1 ? img.height * scale : img.height;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.6));
            };
        };
    });
  }

  // === ç·¨è¼¯èˆ‡é‡ç½® ===
  window.editRecord = (id) => {
    const r = dbData.find(x => x.id === id); if(!r) return;
    $('#editId').value = r.id; $('#unit').value = r.unit; $('#contact').value = r.contact; $('#phone').value = r.phone; $('#email').value = r.email; $('#facility').value = r.facility; $('#purpose').value = r.purpose;
    $('#date').value = r.date; $('#startTime').value = r.startTime; $('#endTime').value = r.endTime;
    $('#modeSingle').checked = true; updateApplyMode();
    $('#formTitle').textContent = "ç·¨è¼¯é ç´„ç”³è«‹"; $('#submitBtn').innerHTML = "<i class='ri-save-line'></i> å„²å­˜è®Šæ›´"; $('#submitBtn').classList.add('bg-emerald-600'); $('#cancelEditBtn').classList.remove('hidden');
    switchView('form');
  };

  $('#cancelEditBtn').onclick = resetForm;

  function resetForm() {
    $('#bookingForm').reset(); $('#editId').value = ""; $('#date').value = new Date().toISOString().slice(0, 10);
    // é‡ç½®æ—¥æ›†é¸æ“‡
    selectedDatesSet.clear(); finalSelectedDates = []; renderDateTags();
    $('#formTitle').textContent = "æ–°å¢é ç´„ç”³è«‹"; $('#submitBtn').innerHTML = "<i class='ri-send-plane-fill'></i> æäº¤ç”³è«‹"; $('#submitBtn').classList.remove('bg-emerald-600'); $('#submitBtn').classList.add('bg-slate-900');
    $('#cancelEditBtn').classList.add('hidden');
    $('#modeSingle').checked = true; updateApplyMode();
  }

  // === å–æ¶ˆç”³è«‹ ===
  window.openCancelModal = (id, isBatch) => {
    $('#cancelTargetId').value = id; $('#cancelType').value = isBatch ? 'batch' : 'single'; $('#verifyEmail').value = ''; $('#cancelReason').value = '';
    $('#cancelModal').classList.replace('hidden', 'flex');
  };

  $('#cancelForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = $('#confirmCancelBtn'); btn.innerHTML = 'é©—è­‰ä¸­...'; btn.disabled = true;
    try {
        const res = await fetch(GAS_ENDPOINT, { method: 'POST', headers: {"Content-Type": "text/plain"}, body: JSON.stringify({ action: $('#cancelType').value === 'batch' ? 'cancel_batch' : 'cancel_request', [$('#cancelType').value === 'batch' ? 'batchId' : 'id']: $('#cancelTargetId').value, verifyEmail: $('#verifyEmail').value.trim(), reason: $('#cancelReason').value.trim() }) });
        const result = await res.json();
        if(result.status === 'success') { showToast('å·²é€å‡º', 'å–æ¶ˆç”³è«‹å·²é€äº¤ç®¡ç†è€…', 'success'); $('#cancelModal').classList.replace('flex', 'hidden'); setTimeout(fetchData, 1500); }
        else alert(result.message || 'ç”³è«‹å¤±æ•—');
    } catch(err) { showToast('éŒ¯èª¤', 'è«‹ç¨å¾Œå†è©¦', 'error'); } finally { btn.innerHTML = 'é€å‡º'; btn.disabled = false; }
  });

  // === åˆ—è¡¨æ¸²æŸ“ ===
  function renderList() {
    const container = $('#bookingListContainer'); if(!container) return; container.innerHTML = '';
    const filter = $('#searchInput').value.toLowerCase();
    const activeList = dbData.filter(x => !x.status.includes("å–æ¶ˆ") && !x.status.includes("æ‹’çµ•")).filter(x => (x.unit + x.contact + x.facility).toLowerCase().includes(filter));
    const groups = {}; activeList.forEach(item => { const key = item.batchId || item.id; if(!groups[key]) groups[key] = []; groups[key].push(item); });
    const sortedKeys = Object.keys(groups).sort((a, b) => groups[a][0].date.localeCompare(groups[b][0].date));
    if(sortedKeys.length === 0) { container.innerHTML = '<div class="text-center text-slate-400 py-10">ç„¡è³‡æ–™</div>'; return; }
    
    const today = new Date().toISOString().slice(0, 10);
    sortedKeys.forEach(key => {
        const items = groups[key], f = items[0], isMulti = items.length > 1;
        const color = f.status.includes("æ ¸å‡†") ? "text-emerald-600 bg-emerald-50" : (f.status.includes("æ’æœŸ") ? "text-rose-600 bg-rose-50" : "text-amber-600 bg-amber-50");
        let missingPhotoInfo = '';
        if(f.status.includes("æ ¸å‡†") && f.date <= today && items.some(i => !(i.uploadStatus||"").includes("å‰") || !(i.uploadStatus||"").includes("ä¸­") || !(i.uploadStatus||"").includes("å¾Œ"))) {
            missingPhotoInfo = `<div class="ml-2 flex items-center gap-2"><span class="text-xs text-rose-600 font-bold">â— ç¼ºä»¶</span></div>`;
        }
        const card = document.createElement('div');
        card.className = "card-root bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden mb-3";
        card.innerHTML = `
            <div class="p-4 flex items-center justify-between cursor-pointer bg-white hover:bg-gray-50" onclick="this.nextElementSibling.classList.toggle('hidden')">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${color} font-bold"><i class="ri-calendar-check-line"></i></div>
                    <div><div class="font-bold text-slate-800 flex items-center gap-2">${f.unit} <span class="text-xs font-normal text-slate-500">(${f.contact})</span>${missingPhotoInfo}</div>
                    <div class="text-xs text-slate-500 mt-0.5">${isMulti ? `<span class="bg-slate-100 px-1.5 py-0.5 rounded font-mono mr-1">å…±${items.length}å¤©</span>` : ''}${f.date} Â· ${f.facility}</div></div>
                </div>
                <div class="flex items-center gap-2"><span class="text-xs font-bold px-2 py-1 rounded ${color}">${f.status.split(' ')[1]||f.status}</span>${isMulti ? `<button onclick="event.stopPropagation(); openCancelModal('${f.batchId}', true)" class="text-rose-500 hover:bg-rose-50 p-1.5 rounded text-xs border border-rose-200"><i class="ri-close-circle-line"></i> æ•´æ‰¹å–æ¶ˆ</button>` : ''}</div>
            </div>
            <div class="details-panel hidden border-t border-slate-100 bg-slate-50 p-3 space-y-2">
                ${items.map(i => `<div class="flex flex-col gap-2 bg-white p-2 rounded border border-slate-200"><div class="flex items-center justify-between text-sm"><div class="flex items-center gap-3"><span class="font-mono text-slate-600">${i.date}</span><span class="font-mono font-bold text-indigo-600">${i.startTime}-${i.endTime}</span><span class="text-slate-500 text-xs">${i.status}</span></div><div class="flex gap-2 items-center">${i.status.includes('æ ¸å‡†') ? `<button onclick="openPhotoModal('${i.id}')" class="text-indigo-500 hover:bg-indigo-50 p-1 rounded"><i class="ri-camera-line text-lg"></i></button>` : ''}<button onclick="openCancelModal('${i.id}', false)" class="text-rose-500 hover:bg-rose-50 p-1 rounded"><i class="ri-close-circle-line"></i></button></div></div>${i.folderUrl ? `<div class="text-xs flex items-center justify-between bg-slate-50 p-1 rounded"><a href="${i.folderUrl}" target="_blank" class="text-blue-500 hover:underline flex items-center gap-1"><i class="ri-folder-open-line"></i> é–‹å•Ÿè³‡æ–™å¤¾</a></div>` : ''}</div>`).join('')}
            </div>`;
        container.appendChild(card);
    });
  }
  $('#searchInput').addEventListener('input', renderList);

  // ==================== CSV åŒ¯å‡º ====================
  $('#exportCsvBtn').onclick = () => {
    if(!dbData.length) return alert('ç„¡è³‡æ–™');
    const csv = '\ufeffç‹€æ…‹,æ—¥æœŸ,é–‹å§‹,çµæŸ,å ´åœ°,å–®ä½\n' + dbData.map(r => `${r.status},${r.date},${r.startTime},${r.endTime},"${r.facility}","${r.unit}"`).join('\n');
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'})); a.download = 'Booking.csv'; a.click();
  };

  function showToast(t, m, type) {
    const o = $('#toast'); $('#toastTitle').textContent = t; $('#toastMsg').textContent = m;
    $('#toastIcon').className = `text-2xl ri-${type === 'success' ? 'checkbox-circle-fill text-emerald-400' : 'error-warning-fill text-rose-400'}`;
    o.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => o.classList.add('translate-y-20', 'opacity-0'), 3000);
  }

  window.switchView = (v) => { document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden')); $('#view-'+v).classList.remove('hidden'); };
</script>
</body>
</html>
