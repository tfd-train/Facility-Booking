<script>
  // ==================== 全域設定 ====================
  const $ = (s) => document.querySelector(s);
  let dbData = [];

  // ★ 填入你的 Apps Script Web App URL
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzGm6VBe6xHU-nLOuM9Txr_MHara2hj079cLwuPlNQIn20JlXAHlWkYGOrBAcoK0EQ/exec';
  // ★ 填入你的 Google 日曆 embed URL
  const CALENDAR_EMBED_URL = 'https://calendar.google.com/calendar/embed?src=5d3470b8ffb11daa8db6817414d5eedacc728c0cde687d295a3b29e5e82214d1%40group.calendar.google.com&ctz=Asia%2FTaipei';

  // ==================== UUID 產生器 ====================
  // 解決 crypto.randomUUID 在非 HTTPS 環境報錯的問題
  function generateUUID() {
    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
      try { return crypto.randomUUID(); } catch(e) {}
    }
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  // ==================== 共用 UI / 初始化 ====================
  function toggleMobileSidebar() {
    const a = $('aside');
    if (!a) return;
    a.classList.toggle('hidden');
    a.classList.toggle('absolute');
    a.classList.toggle('h-full');
  }

  // 初始化日曆與日期
  if ($('#calendarFrame')) $('#calendarFrame').src = CALENDAR_EMBED_URL;
  if ($('#date')) $('#date').value = new Date().toISOString().slice(0, 10);

  const SAFETY_HIGH = "⚠️ 依內政部消防署109年9月29日消署訓字第1091700957號函頒「消防機關辦理各項救災訓練安全管理指導原則」辦理，請指派資深教官負責全盤訓練安全事宜。\n⚠️ 借用單位請於訓後將場地復原並維持場地整潔。";
  const SAFETY_LOW = "⚠️ 請借用單位訓後將場地復原並維持場地整潔。";

  // ==================== 場地選擇 → 安全文字 ====================
  const facilityEl = $('#facility');
  if (facilityEl) {
    facilityEl.addEventListener('change', (e) => {
      const val = e.target.value;
      const customInput = $('#customFacility');
      if (customInput) {
        if (val === 'other') {
          customInput.classList.remove('hidden');
          customInput.required = true;
        } else {
          customInput.classList.add('hidden');
          customInput.required = false;
          customInput.value = "";
        }
      }
      const isHigh = ["燃燒櫃", "燃燒室", "空呼氣訓練場", "AB塔", "大直訓練場"].includes(val) || val === 'other';
      const safetyTextEl = $('#safetyText');
      if (safetyTextEl) safetyTextEl.innerText = isHigh ? SAFETY_HIGH : SAFETY_LOW;
    });
  }
  if ($('#safetyText')) $('#safetyText').innerText = SAFETY_LOW;

  // ==================== 全天勾選 ====================
  const isAllDayEl = $('#isAllDay');
  if (isAllDayEl) {
    isAllDayEl.addEventListener('change', (e) => {
      const s = $('#startTime'), eEnd = $('#endTime');
      if (!s || !eEnd) return;
      if (e.target.checked) {
        s.value = "08:00";
        eEnd.value = "17:00";
        s.classList.add('disabled-input');
        eEnd.classList.add('disabled-input');
      } else {
        s.classList.remove('disabled-input');
        eEnd.classList.remove('disabled-input');
      }
    });
  }

  // ==================== 申請模式：單日 / 多日 ====================
  function updateApplyMode() {
    const modeInput = document.querySelector('input[name="applyMode"]:checked');
    const mode = modeInput ? modeInput.value : 'single';
    const singleRow = $('#singleDateRow');
    const multiWrap  = $('#multiDateWrap');
    const singleDate = $('#date');
    const dStart = $('#dateStart');
    const dEnd   = $('#dateEnd');

    if (!singleRow || !multiWrap) return;

    if (mode === 'single') {
      singleRow.classList.remove('hidden');
      multiWrap.classList.add('hidden');
      if (singleDate) singleDate.required = true;
      if (dStart) dStart.required = false;
      if (dEnd)   dEnd.required   = false;
    } else {
      singleRow.classList.add('hidden');
      multiWrap.classList.remove('hidden');
      if (singleDate) singleDate.required = false;
      if (dStart) dStart.required = true;
      if (dEnd)   dEnd.required   = true;
    }
  }

  const applyModeRadios = document.querySelectorAll('input[name="applyMode"]');
  if (applyModeRadios.length) {
    applyModeRadios.forEach(r => {
      r.addEventListener('change', updateApplyMode);
    });
    updateApplyMode();
  }

  // ==================== 從 GAS 抓資料 ====================
  async function fetchData() {
    try {
      const res = await fetch(GAS_ENDPOINT);
      dbData = await res.json();
      updateWeeklyNotice();
      renderList();
      renderTodo();
      showToast('同步完成', '資料已更新', 'success');
    } catch (e) {
      console.error(e);
      showToast('同步失敗', '無法取得最新資料', 'error');
    }
  }

  const syncBtn = $('#syncBtn');
  if (syncBtn) syncBtn.onclick = fetchData;
  // 載入頁面時自動同步一次
  fetchData();

  // ==================== Helper：判斷缺哪些照片 ====================
  function getMissingParts(statusStr) {
    const missing = [];
    if (!statusStr.includes('使用前')) missing.push('前');
    if (!statusStr.includes('使用中')) missing.push('中');
    if (!statusStr.includes('歸還後')) missing.push('後');
    return missing;
  }

  // ==================== 待補照片提醒區塊 ====================
  function renderTodo() {
    const todoContainer = $('#todoList');
    const todoSection = $('#todoSection');
    const badge = $('#pendingBadge');
    if (!todoContainer || !todoSection || !badge) return;

    const today = new Date().toISOString().slice(0, 10);

    const pendingItems = dbData.filter(x => {
      if (!x.status.includes('已核准')) return false;
      if (x.date > today) return false;
      const s = x.uploadStatus || "";
      return !(s.includes("使用前") && s.includes("使用中") && s.includes("歸還後"));
    });

    if (pendingItems.length > 0) {
      badge.innerText = pendingItems.length;
      badge.classList.remove('hidden');
      todoSection.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
      todoSection.classList.add('hidden');
      return;
    }

    todoContainer.innerHTML = pendingItems.map(item => {
      const missing = getMissingParts(item.uploadStatus || "");
      const missingText = missing.join('、');
      return `
        <div class="flex items-center justify-between bg-white p-2.5 rounded-lg border border-rose-100 shadow-sm">
          <div class="flex flex-col">
            <div class="text-xs font-bold text-slate-700">${item.date} ${item.facility}</div>
            <div class="text-[10px] text-rose-600 font-bold">❌ 缺：${missingText}</div>
          </div>
          <button onclick="switchView('list'); openPhotoModal('${item.id}')" class="text-xs bg-rose-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-rose-700 shadow-md btn-alert">
            <i class="ri-camera-fill"></i> 上傳
          </button>
        </div>
      `;
    }).join('');
  }

  // ==================== 近期 7 天預約資訊 ====================
  function updateWeeklyNotice() {
    const con = $('#weeklyNotice');
    if (!con) return;
    con.innerHTML = '';
    let has = false;
    for (let i = 0; i < 7; i++) {
      const d = new Date();
      d.setDate(new Date().getDate() + i);
      const ds = d.toISOString().slice(0, 10);
      const books = dbData.filter(x => x.date === ds && x.status.includes('已核准'));
      if (books.length) {
        has = true;
        con.innerHTML += `
          <div class="text-xs border-b border-slate-100 pb-2 last:border-0">
            <div class="font-bold text-indigo-600 mb-1">${ds}</div>
            ${books.map(b => `
              <div class="flex justify-between bg-slate-50 px-2 py-1 rounded text-slate-600">
                <span>${b.facility}</span>
                <span>${b.startTime}-${b.endTime}</span>
              </div>`).join('')}
          </div>`;
      }
    }
    if (!has) con.innerHTML = '<div class="text-sm text-slate-400 py-4 text-center">未來 7 天無核准預約</div>';
  }

  // ==================== 表單送出（單日 / 多日 + 批次建立） ====================
  const bookingForm = $('#bookingForm');
  if (bookingForm) {
    bookingForm.addEventListener('submit', async e => {
      e.preventDefault();

      const startTimeEl = $('#startTime');
      const endTimeEl = $('#endTime');

      // 時間防呆
      if (startTimeEl && endTimeEl && startTimeEl.value && endTimeEl.value) {
        if (endTimeEl.value <= startTimeEl.value) {
          alert('時間錯誤：結束時間需晚於開始時間');
          return;
        }
      }

      let facVal = facilityEl ? facilityEl.value : '';
      const customFacilityEl = $('#customFacility');
      if (facVal === 'other' && customFacilityEl) facVal = customFacilityEl.value.trim();
      if (!facVal) {
        alert('請選擇或輸入場地');
        return;
      }

      const btn = $('#submitBtn');
      if (!btn) return;

      // 避免重複點擊
      if (btn.disabled) return;
      const originalBtnText = btn.innerHTML;
      btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> 處理中...';
      btn.disabled = true;

      try {
        const isEdit = $('#editId') && $('#editId').value !== "";
        const base = {
          unit: $('#unit') ? $('#unit').value : '',
          contact: $('#contact') ? $('#contact').value : '',
          phone: $('#phone') ? $('#phone').value : '',
          email: $('#email') ? $('#email').value : '',
          facility: facVal,
          purpose: $('#purpose') ? $('#purpose').value : '',
          startTime: startTimeEl ? startTimeEl.value : '',
          endTime: endTimeEl ? endTimeEl.value : '',
          id: isEdit ? $('#editId').value : generateUUID()
        };

        if (isEdit) {
          await fetch(GAS_ENDPOINT, {
            method: 'POST',
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({ ...base, date: $('#date') ? $('#date').value : '', action: 'edit' })
          });
          showToast('更新成功', '已儲存變更', 'success');
          resetForm();
          setTimeout(fetchData, 1500);
        } else {
          // 申請模式：single = 單日、multi = 多日
          const modeInput = document.querySelector('input[name="applyMode"]:checked');
          const applyMode = modeInput ? modeInput.value : 'single';
          let dates = [];

          if (applyMode === 'single') {
            const singleDateEl = $('#date');
            const singleDate = singleDateEl ? singleDateEl.value : '';
            if (!singleDate) throw new Error('請填寫單日日期');
            dates = [singleDate];
          } else {
            const dStartEl = $('#dateStart');
            const dEndEl   = $('#dateEnd');
            const modeSel  = $('#dateMode');

            const dStart = dStartEl ? dStartEl.value : '';
            const dEnd   = dEndEl ? dEndEl.value : '';
            const mode   = modeSel ? modeSel.value : 'all';

            if (!dStart || !dEnd) throw new Error('請填寫多日起訖日期');

            const start = new Date(dStart);
            const end   = new Date(dEnd);
            if (end < start) throw new Error('多日區間錯誤：結束日期需晚於起始日期');

            let c = new Date(start);
            while (c <= end) {
              const day = c.getDay();
              let add = true;
              if (mode === 'weekday' && (day === 0 || day === 6)) add = false;
              if (mode === 'weekend' && (day !== 0 && day !== 6)) add = false;
              if (add) dates.push(c.toISOString().slice(0, 10));
              c.setDate(c.getDate() + 1);
            }
            if (!dates.length) throw new Error('多日區間內無有效日期（可能全部被排除為週末或平日）');
          }

          // 發送請求：批次建立
          await fetch(GAS_ENDPOINT, {
            method: 'POST',
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({ ...base, dates: dates, action: 'create_batch' })
          });
          showToast('申請成功', `已送出 ${dates.length} 筆紀錄，待審核。`, 'success');
          resetForm();
          setTimeout(fetchData, 1500);
        }
      } catch (err) {
        console.error(err);
        alert('提交失敗: ' + (err.message || '未知錯誤'));
        showToast('提交失敗', '請稍後再試或聯絡管理者', 'error');
      } finally {
        btn.innerHTML = originalBtnText;
        btn.classList.remove('bg-emerald-600');
        btn.classList.add('bg-slate-900');
        if ($('#editId') && $('#editId').value) {
          btn.innerHTML = "<i class='ri-save-line'></i> 儲存變更";
          btn.classList.add('bg-emerald-600');
        } else {
          btn.innerHTML = "<i class='ri-send-plane-fill'></i> 提交申請";
        }
        btn.disabled = false;
      }
    });
  }

  // ==================== 照片預覽 & 上傳 ====================
  const photoFileEl = $('#photoFile');
  if (photoFileEl) {
    photoFileEl.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e2) => {
          const preview = $('#photoPreview');
          if (!preview) return;
          preview.style.backgroundImage = `url(${e2.target.result})`;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });
  }

  window.openPhotoModal = (id) => {
    const targetId = $('#photoTargetId');
    const photoFile = $('#photoFile');
    const preview = $('#photoPreview');
    const progressText = $('#progressText');
    const modal = $('#photoModal');
    if (!targetId || !photoFile || !preview || !progressText || !modal) return;
    targetId.value = id;
    photoFile.value = '';
    preview.classList.add('hidden');
    progressText.classList.add('hidden');
    modal.classList.replace('hidden', 'flex');
  };

  const photoForm = $('#photoForm');
  if (photoForm) {
    photoForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = $('#photoFile');
      if (!fileInput) return;
      const file = fileInput.files[0];
      if (!file) return alert('請選擇照片');

      const btn = $('#uploadBtn');
      const pt = $('#progressText');
      if (!btn || !pt) return;

      btn.innerHTML = '處理中...';
      btn.disabled = true;
      pt.textContent = '正在壓縮圖片...';
      pt.classList.remove('hidden');

      try {
        const resized = await compressImage(file);
        const typeInput = document.querySelector('input[name="photoType"]:checked');
        const type = typeInput ? typeInput.value : '使用前';
        pt.textContent = '正在上傳至雲端...';

        const res = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({
            action: 'upload_photo',
            id: $('#photoTargetId') ? $('#photoTargetId').value : '',
            fileData: resized.split(',')[1],
            mimeType: 'image/jpeg',
            photoType: type
          })
        });
        const result = await res.json();
        if (result.status === 'success') {
          showToast('上傳成功', '照片已存入雲端', 'success');
          const modal = $('#photoModal');
          if (modal) modal.classList.replace('flex', 'hidden');
          setTimeout(fetchData, 1500);
        } else {
          alert(result.message || '上傳失敗');
        }
      } catch (err) {
        console.error(err);
        alert('上傳過程發生錯誤');
      } finally {
        btn.innerHTML = '開始上傳';
        btn.disabled = false;
        pt.classList.add('hidden');
      }
    });
  }

  function compressImage(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const scale = 800 / img.width;
          canvas.width = scale < 1 ? 800 : img.width;
          canvas.height = scale < 1 ? img.height * scale : img.height;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL('image/jpeg', 0.6));
        };
      };
    });
  }

  // ==================== 編輯紀錄 ====================
  window.editRecord = (id) => {
    const r = dbData.find(x => x.id === id);
    if (!r) return;
    if ($('#editId')) $('#editId').value = r.id;
    if ($('#unit')) $('#unit').value = r.unit;
    if ($('#contact')) $('#contact').value = r.contact;
    if ($('#phone')) $('#phone').value = r.phone;
    if ($('#email')) $('#email').value = r.email;
    if ($('#facility')) $('#facility').value = r.facility;
    if ($('#purpose')) $('#purpose').value = r.purpose;
    if ($('#date')) $('#date').value = r.date;
    if ($('#startTime')) $('#startTime').value = r.startTime;
    if ($('#endTime')) $('#endTime').value = r.endTime;

    // 編輯狀態固定用單日模式
    const modeSingle = $('#modeSingle');
    const modeMulti  = $('#modeMulti');
    if (modeSingle) modeSingle.checked = true;
    if (modeMulti) modeMulti.checked = false;
    updateApplyMode();

    const formTitle = $('#formTitle');
    const submitBtn = $('#submitBtn');
    const cancelEditBtn = $('#cancelEditBtn');
    if (formTitle) formTitle.textContent = "編輯預約申請";
    if (submitBtn) {
      submitBtn.innerHTML = "<i class='ri-save-line'></i> 儲存變更";
      submitBtn.classList.remove('bg-slate-900');
      submitBtn.classList.add('bg-emerald-600');
    }
    if (cancelEditBtn) cancelEditBtn.classList.remove('hidden');
    switchView('form');
  };

  const cancelEditBtnEl = $('#cancelEditBtn');
  if (cancelEditBtnEl) cancelEditBtnEl.onclick = resetForm;

  function resetForm() {
    const bookingForm = $('#bookingForm');
    if (bookingForm) bookingForm.reset();
    if ($('#editId')) $('#editId').value = "";
    if ($('#date')) $('#date').value = new Date().toISOString().slice(0, 10);
    if ($('#facility')) $('#facility').value = "";
    const customFacility = $('#customFacility');
    if (customFacility) customFacility.classList.add('hidden');
    const formTitle = $('#formTitle');
    const submitBtn = $('#submitBtn');
    const cancelEditBtn = $('#cancelEditBtn');
    if (formTitle) formTitle.textContent = "新增預約申請";
    if (submitBtn) {
      submitBtn.innerHTML = "<i class='ri-send-plane-fill'></i> 提交申請";
      submitBtn.classList.remove('bg-emerald-600');
      submitBtn.classList.add('bg-slate-900');
    }
    if (cancelEditBtn) cancelEditBtn.classList.add('hidden');
    if ($('#isAllDay')) $('#isAllDay').checked = false;
    if ($('#startTime')) $('#startTime').classList.remove('disabled-input');
    if ($('#endTime')) $('#endTime').classList.remove('disabled-input');
    if ($('#safetyText')) $('#safetyText').innerText = SAFETY_LOW;

    // 重設模式為單日
    const modeSingle = $('#modeSingle');
    const modeMulti  = $('#modeMulti');
    if (modeSingle) modeSingle.checked = true;
    if (modeMulti) modeMulti.checked = false;
    updateApplyMode();
  }

  // ==================== 取消申請（單一 / 整批） ====================
  window.openCancelModal = (id, isBatch) => {
    const targetId = $('#cancelTargetId');
    const typeEl = $('#cancelType');
    const verifyEmail = $('#verifyEmail');
    const cancelReason = $('#cancelReason');
    const modal = $('#cancelModal');
    if (!targetId || !typeEl || !verifyEmail || !cancelReason || !modal) return;
    targetId.value = id;
    typeEl.value = isBatch ? 'batch' : 'single';
    verifyEmail.value = '';
    cancelReason.value = '';
    modal.classList.replace('hidden', 'flex');
  };

  const cancelForm = $('#cancelForm');
  if (cancelForm) {
    cancelForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = $('#confirmCancelBtn');
      if (!btn) return;
      btn.innerHTML = '驗證中...';
      btn.disabled = true;
      try {
        const typeEl = $('#cancelType');
        const isBatch = typeEl && typeEl.value === 'batch';
        const body = {
          action: isBatch ? 'cancel_batch' : 'cancel_request',
          [isBatch ? 'batchId' : 'id']: $('#cancelTargetId') ? $('#cancelTargetId').value : '',
          verifyEmail: $('#verifyEmail') ? $('#verifyEmail').value.trim() : '',
          reason: $('#cancelReason') ? $('#cancelReason').value.trim() : ''
        };
        const res = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        if (result.status === 'success') {
          showToast('已送出', '取消申請已送交管理者', 'success');
          const modal = $('#cancelModal');
          if (modal) modal.classList.replace('flex', 'hidden');
          setTimeout(fetchData, 1500);
        } else {
          alert(result.message || '申請失敗');
        }
      } catch (err) {
        console.error(err);
        showToast('錯誤', '請稍後再試', 'error');
      } finally {
        btn.innerHTML = '送出';
        btn.disabled = false;
      }
    });
  }

  // ==================== 列表渲染 ====================
  function renderList() {
    const container = $('#bookingListContainer');
    if (!container) return;
    container.innerHTML = '';
    const searchInput = $('#searchInput');
    const filter = (searchInput ? searchInput.value : '').toLowerCase();
    let activeList = dbData.filter(x => !x.status.includes("取消") && !x.status.includes("拒絕"));
    activeList = activeList.filter(x => (x.unit + x.contact + x.facility).toLowerCase().includes(filter));

    const groups = {};
    activeList.forEach(item => {
      const key = item.batchId || item.id;
      if (!groups[key]) groups[key] = [];
      groups[key].push(item);
    });

    const sortedKeys = Object.keys(groups).sort((a, b) => groups[a][0].date.localeCompare(groups[b][0].date));
    if (sortedKeys.length === 0) {
      container.innerHTML = '<div class="text-center text-slate-400 py-10">無資料</div>';
      return;
    }

    const today = new Date().toISOString().slice(0, 10);

    sortedKeys.forEach(key => {
      const items = groups[key];
      const f = items[0];
      const isMulti = items.length > 1;
      const color = f.status.includes("核准") ? "text-emerald-600 bg-emerald-50" :
                    (f.status.includes("撞期") ? "text-rose-600 bg-rose-50" : "text-amber-600 bg-amber-50");

      let missingPhotoInfo = '';
      if (f.status.includes("核准") && f.date <= today) {
        const anyMissing = items.some(item => {
          const s = item.uploadStatus || "";
          return !(s.includes("使用前") && s.includes("使用中") && s.includes("歸還後"));
        });
        if (anyMissing) {
          const missingParts = getMissingParts(items[0].uploadStatus || "");
          const missingText = missingParts.join('、');
          missingPhotoInfo = `
            <div class="ml-2 flex items中心 gap-2">
              <span class="text-xs text-rose-600 font-bold">尚缺: ${missingText}</span>
              <button onclick="event.stopPropagation(); this.closest('.card-root').querySelector('.details-panel').classList.remove('hidden');" class="bg-rose-600 text-white text-xs px-2 py-1 rounded shadow btn-alert">
                <i class="ri-camera-fill"></i>
              </button>
            </div>`;
        }
      }

      const card = document.createElement('div');
      card.className = "card-root bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden mb-3";
      card.innerHTML = `
        <div class="p-4 flex items-center justify-between cursor-pointer bg-white hover:bg-gray-50" onclick="this.nextElementSibling.classList.toggle('hidden')">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center ${color} font-bold">
              <i class="ri-calendar-check-line"></i>
            </div>
            <div>
              <div class="font-bold text-slate-800 flex items-center gap-2">
                ${f.unit} <span class="text-xs font-normal text-slate-500">(${f.contact})</span>
                ${missingPhotoInfo}
              </div>
              <div class="text-xs text-slate-500 mt-0.5">
                ${isMulti ? `<span class="bg-slate-100 px-1.5 py-0.5 rounded font-mono mr-1">共${items.length}天</span>` : ''}
                ${f.date} · ${f.facility}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs font-bold px-2 py-1 rounded ${color}">${f.status.split(' ')[1] || f.status}</span>
            ${isMulti ? `<button onclick="event.stopPropagation(); openCancelModal('${f.batchId}', true)" class="text-rose-500 hover:bg-rose-50 p-1.5 rounded text-xs border border-rose-200"><i class="ri-close-circle-line"></i> 整批取消</button>` : ''}
            <i class="ri-arrow-down-s-line text-slate-400"></i>
          </div>
        </div>
        <div class="details-panel hidden border-t border-slate-100 bg-slate-50 p-3 space-y-2">
          ${items.map(item => {
            const statusStr = item.uploadStatus || "";
            const isComplete = statusStr.includes("使用前") && statusStr.includes("使用中") && statusStr.includes("歸還後");
            let photoBadge = '';
            let uploadBtnClass = "text-indigo-500 hover:bg-indigo-50 p-1 rounded";

            if (item.status.includes('核准')) {
              if (item.date > today) photoBadge = `<span class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">未開始</span>`;
              else if (isComplete) photoBadge = `<span class="text-xs text-emerald-600 bg-emerald-100 px-1.5 py-0.5 rounded">● 已結案</span>`;
              else if (item.date === today) photoBadge = `<span class="text-xs text-amber-600 bg-amber-100 px-1.5 py-0.5 rounded">● 進行中</span>`;
              else {
                photoBadge = `<span class="text-xs text-rose-600 bg-rose-100 px-1.5 py-0.5 rounded font-bold">● 缺件</span>`;
                uploadBtnClass = "bg-rose-600 text-white p-1.5 rounded shadow btn-alert hover:bg-rose-700";
              }
            }

            return `
              <div class="flex flex-col gap-2 bg-white p-2 rounded border border-slate-200">
                <div class="flex items-center justify-between text-sm">
                  <div class="flex items-center gap-3">
                    <span class="font-mono text-slate-600">${item.date}</span>
                    <span class="font-mono font-bold text-indigo-600">${item.startTime}-${item.endTime}</span>
                    <span class="text-slate-500 text-xs">${item.status}</span>
                    ${photoBadge}
                  </div>
                  <div class="flex gap-2 items-center">
                    ${item.status.includes('核准') ? `<button onclick="openPhotoModal('${item.id}')" class="${uploadBtnClass}" title="上傳照片"><i class="ri-camera-line text-lg"></i>${!isComplete && item.date <= today ? '<span class="text-xs ml-1">上傳</span>' : ''}</button>` : ''}
                    ${(item.status.includes('待審核') || item.status.includes('撞期')) ? `<button onclick="editRecord('${item.id}')" class="text-indigo-500 hover:bg-indigo-50 p-1 rounded"><i class="ri-edit-line"></i></button>` : ''}
                    <button onclick="openCancelModal('${item.id}', false)" class="text-rose-500 hover:bg-rose-50 p-1 rounded"><i class="ri-close-circle-line"></i></button>
                  </div>
                </div>
                ${item.folderUrl ? `
                  <div class="text-xs flex items-center justify-between bg-slate-50 p-1 rounded">
                    <a href="${item.folderUrl}" target="_blank" class="text-blue-500 hover:underline flex items-center gap-1">
                      <i class="ri-folder-open-line"></i> 開啟照片資料夾
                    </a>
                    <span class="text-slate-400 text-[10px]">${item.uploadStatus || ''}</span>
                  </div>` : ''}
              </div>`;
          }).join('')}
        </div>`;
      container.appendChild(card);
    });
  }

  const searchInputEl = $('#searchInput');
  if (searchInputEl) searchInputEl.addEventListener('input', renderList);

  // ==================== 匯出 CSV ====================
  const exportCsvBtn = $('#exportCsvBtn');
  if (exportCsvBtn) {
    exportCsvBtn.onclick = () => {
      if (!dbData.length) {
        alert('目前沒有可匯出的資料');
        return;
      }
      const csv = '\ufeff狀態,日期,開始,結束,場地,單位\n' +
        dbData.map(r => `${r.status},${r.date},${r.startTime},${r.endTime},"${r.facility}","${r.unit}"`).join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = 'Booking.csv';
      a.click();
    };
  }

  // ==================== Toast ====================
  function showToast(t, m, type) {
    const o = $('#toast');
    if (!o) return;
    const titleEl = $('#toastTitle');
    const msgEl = $('#toastMsg');
    const iconEl = $('#toastIcon');
    if (titleEl) titleEl.textContent = t;
    if (msgEl) msgEl.textContent = m;
    if (iconEl) iconEl.className = `text-2xl ri-${type === 'success' ? 'checkbox-circle-fill text-emerald-400' : 'error-warning-fill text-rose-400'}`;
    o.classList.remove('translate-y-20', 'opacity-0');
    setTimeout(() => o.classList.add('translate-y-20', 'opacity-0'), 3000);
  }

  // ==================== View 切換 ====================
  window.switchView = (v) => {
    document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
    const target = $('#view-' + v);
    if (target) target.classList.remove('hidden');
  };
</script>
