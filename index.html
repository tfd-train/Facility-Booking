<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>å ´åœ°å€Ÿç”¨ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .input-field { width: 100%; border-radius: 0.5rem; border: 1px solid #e2e8f0; padding: 0.6rem; font-size: 0.875rem; transition: all 0.2s; } 
    .input-field:focus { border-color: #6366f1; outline: 2px solid #e0e7ff; } 
    .disabled-input { background-color: #f3f4f6; color: #9ca3af; pointer-events: none; }
    aside.absolute { bottom: 0; }
    
    /* ç´…è‰²å‘¼å¸ç‡ˆå‹•ç•« (ç”¨æ–¼å¼·èª¿ç¼ºä»¶æŒ‰éˆ•) */
    @keyframes pulse-red {
      0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(225, 29, 72, 0); }
      100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); }
    }
    .btn-alert { animation: pulse-red 2s infinite; }
  </style>

  <script>
    // âš ï¸ ç³»çµ±æ•´åˆé€£çµ (å¯ä¾éœ€æ±‚ä¿®æ”¹)
    const PORTAL_URL = "https://tfd-train.github.io/Training-Management-Platform/"; 
    const OTHER_SYSTEM_URL = "https://tfd-train.github.io/Training-Flow-Management/";
  </script>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex selection:bg-indigo-500 selection:text-white">

  <!-- Sidebar -->
  <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-2xl z-30 transition-all duration-300">
    <div class="p-6 border-b border-slate-800 flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center shadow-lg shadow-indigo-500/50">
        <i class="ri-building-2-fill text-white"></i>
      </div>
      <div>
        <h1 class="font-bold text-lg tracking-wide">å ´åœ°é ç´„</h1>
        <p class="text-xs text-slate-400">è¨“ç·´ä¸­å¿ƒå…§éƒ¨ç³»çµ±</p>
      </div>
    </div>
    
    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <button onclick="switchView('form'); resetForm();" class="nav-btn w-full text-left px-4 py-3 rounded-xl bg-indigo-600/20 text-indigo-300 border border-indigo-500/30 flex items-center gap-3 hover:bg-indigo-600 hover:text-white transition">
        <i class="ri-add-circle-line text-xl"></i> æ–°å¢ç”³è«‹
      </button>
      <button onclick="switchView('list')" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center justify-between transition group">
        <div class="flex items-center gap-3"><i class="ri-file-list-3-line text-xl"></i> é ç´„æ¸…å–®</div>
        <!-- ğŸ”´ Sidebar Badge -->
        <span id="pendingBadge" class="hidden bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm group-hover:bg-white group-hover:text-rose-600">0</span>
      </button>
      <button id="exportCsvBtn" class="w-full text-left px-4 py-2.5 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition text-sm mt-4">
        <i class="ri-file-excel-line"></i> åŒ¯å‡ºå ±è¡¨
      </button>
    </nav>

    <div class="p-4 border-t border-slate-800 space-y-2 bg-slate-900">
        <div class="text-[10px] text-slate-500 font-bold px-4 mb-1 uppercase tracking-wider">ç³»çµ±åˆ‡æ›</div>
        <a href="javascript:void(0)" onclick="location.href=OTHER_SYSTEM_URL" class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white hover:bg-slate-800 transition text-sm">
            <i class="ri-flow-chart text-lg text-blue-400"></i> è¨“ç·´æµè·¯ç³»çµ±
        </a>
        <a href="javascript:void(0)" onclick="location.href=PORTAL_URL" class="flex items-center gap-3 px-4 py-2 rounded-xl text-slate-500 hover:text-white transition text-xs">
            <i class="ri-arrow-left-line"></i> å›æ•´åˆé¦–é 
        </a>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-100">
    <header class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center z-20">
      <h1 class="font-bold text-slate-800 flex items-center gap-2">
        <i class="ri-building-2-fill text-indigo-600"></i> å ´åœ°é ç´„
      </h1>
      <div class="flex gap-4 items-center">
        <a href="javascript:void(0)" onclick="location.href=PORTAL_URL" class="text-slate-400 hover:text-indigo-600"><i class="ri-home-4-line text-xl"></i></a>
        <button onclick="toggleMobileSidebar()" class="text-slate-600 p-2"><i class="ri-menu-line text-xl"></i></button>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
      
      <!-- View: Form -->
      <div id="view-form" class="max-w-7xl mx-auto animate-fade-in grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            
            <!-- ğŸ”´ å¾…è£œç…§ç‰‡æé†’å€å¡Š -->
            <div id="todoSection" class="hidden bg-rose-50 border border-rose-100 rounded-2xl p-5 shadow-sm relative overflow-hidden">
                <div class="absolute right-0 top-0 w-24 h-24 bg-rose-100 rounded-full -mr-8 -mt-8 opacity-50"></div>
                <h3 class="font-bold text-rose-700 flex items-center gap-2 text-lg relative z-10">
                    <i class="ri-alarm-warning-fill"></i> å¾…è£œç…§ç‰‡æé†’
                </h3>
                <p class="text-sm text-rose-600 mb-3 relative z-10">ä»¥ä¸‹é ç´„å·²æ ¸å‡†ä½†ç…§ç‰‡æœªé½Šå…¨ï¼Œè«‹å„˜é€Ÿè™•ç†ï¼š</p>
                <div id="todoList" class="space-y-2 relative z-10 max-h-48 overflow-y-auto pr-2"></div>
            </div>

            <div class="flex justify-between items-end">
                <div>
                  <h2 id="formTitle" class="text-2xl font-bold text-slate-800">æ–°å¢é ç´„ç”³è«‹</h2>
                  <p class="text-slate-500 text-sm mt-1">è«‹è©³é–±è¦ç¯„ï¼Œé€å‡ºå¾Œç³»çµ±å°‡è‡ªå‹•å¯„ä¿¡é€šçŸ¥ã€‚</p>
                </div>
                <button id="syncBtn" class="text-sm text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg hover:bg-indigo-100 transition flex items-center gap-1">
                  <i class="ri-refresh-line"></i> é‡æ–°åŒæ­¥
                </button>
            </div>
          
            <!-- è¡¨å–®å…§å®¹ -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
                <div class="h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                <form id="bookingForm" class="p-6 md:p-8 space-y-6">
                    <input type="hidden" id="editId">

                    <!-- åŸºæœ¬è³‡æ–™ -->
                    <div class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                          <input id="unit" type="text" class="input-field" placeholder="å€Ÿç”¨å–®ä½ *" required>
                          <input id="contact" type="text" class="input-field" placeholder="è¯çµ¡äººå§“å *" required>
                          <input id="phone" type="tel" class="input-field" placeholder="è¯çµ¡é›»è©± *" required>
                          <input id="email" type="email" class="input-field" placeholder="Email (æ¥æ”¶é€šçŸ¥ç”¨) *" required>
                        </div>
                    </div>

                    <hr class="border-slate-100">

                    <div class="space-y-4">
                        <!-- å ´åœ° -->
                        <select id="facility" class="input-field" required>
                          <option value="" disabled selected>è«‹é¸æ“‡å ´åœ°...</option>
                          <optgroup label="æ•™å­¸å€åŸŸ">
                            <option>æ•™å®¤701</option>
                            <option>æ•™å®¤702</option>
                            <option>æ•™å®¤703</option>
                          </optgroup>
                          <optgroup label="å¯¦é«”è¨“ç·´å ´">
                            <option>ç©ºå‘¼æ°£è¨“ç·´å ´</option>
                            <option>ç‡ƒç‡’æ«ƒ</option>
                            <option>ç‡ƒç‡’å®¤</option>
                            <option>å¤§ç›´è¨“ç·´å ´</option>
                            <option>ABå¡”</option>
                          </optgroup>
                          <option value="other">âœï¸ å…¶ä»– (è‡ªå¡«)</option>
                        </select>
                        <input id="customFacility" type="text" class="input-field hidden" placeholder="è«‹è¼¸å…¥å ´åœ°åç¨±...">

                        <!-- ç”³è«‹æ¨¡å¼åˆ‡æ›ï¼šå–®æ—¥ / å¤šæ—¥äºŒé¸ä¸€ -->
                        <div class="flex flex-wrap items-center gap-3 mb-2">
                          <span class="text-xs text-slate-500 font-bold">ç”³è«‹æ¨¡å¼ï¼š</span>
                          <label class="flex items-center gap-1 text-xs cursor-pointer">
                            <input type="radio" name="applyMode" id="modeSingle" value="single" checked class="w-3 h-3 text-indigo-600">
                            <span>å–®æ—¥ç”³è«‹</span>
                          </label>
                          <label class="flex items-center gap-1 text-xs cursor-pointer">
                            <input type="radio" name="applyMode" id="modeMulti" value="multi" class="w-3 h-3 text-indigo-600">
                            <span>å¤šæ—¥ / é€£çºŒç”³è«‹</span>
                          </label>
                        </div>

                        <!-- å–®æ—¥æ—¥æœŸæ¬„ -->
                        <div id="singleDateRow" class="grid md:grid-cols-3 gap-4 items-start">
                          <div class="space-y-1">
                            <input id="date" type="date" class="input-field" required>
                            <p class="text-[10px] text-slate-400 mt-1">å–®æ—¥ç”³è«‹æ™‚ï¼Œè«‹å¡«å¯«æ­¤æ¬„ä½ã€‚</p>
                          </div>
                          <!-- æ™‚é–“æ¬„ä½ï¼šå–®æ—¥ã€å¤šæ—¥å…±ç”¨ -->
                          <div id="timeRow" class="col-span-2 space-y-2">
                            <div class="flex items-center gap-2 p-1 bg-slate-50 rounded border border-slate-200">
                              <input type="checkbox" id="isAllDay" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer">
                              <label for="isAllDay" class="text-sm text-slate-700 font-medium cursor-pointer select-none">å…¨å¤©å€Ÿç”¨ (08:00 - 17:00)</label>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                              <input id="startTime" type="time" class="input-field" required>
                              <input id="endTime" type="time" class="input-field" required>
                            </div>
                          </div>
                        </div>

                        <!-- å¤šæ—¥ / é€£çºŒç”³è«‹å€å¡Šï¼ˆé è¨­éš±è—ï¼‰ -->
                        <div id="multiDateWrap" class="mt-3 hidden">
                          <div class="bg-slate-50 rounded-xl border border-slate-200 p-4">
                            <div class="grid grid-cols-2 gap-3">
                              <div>
                                <label class="text-[10px] text-slate-400 font-bold">èµ·å§‹æ—¥æœŸ</label>
                                <input id="dateStart" type="date" class="input-field text-sm p-2">
                              </div>
                              <div>
                                <label class="text-[10px] text-slate-400 font-bold">çµæŸæ—¥æœŸ</label>
                                <input id="dateEnd" type="date" class="input-field text-sm p-2">
                              </div>
                            </div>
                            <div class="mt-2">
                              <select id="dateMode" class="input-field text-sm py-1">
                                <option value="all">é€£çºŒæ—¥æœŸ (å«å…­æ—¥)</option>
                                <option value="weekday">æ’é™¤é€±æœ«</option>
                                <option value="weekend">åƒ…é™é€±æœ«</option>
                              </select>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2">
                              å¤šæ—¥ç”³è«‹æ™‚ï¼Œå°‡ä¾å€é–“è‡ªå‹•ç”¢ç”Ÿå¤šç­†ç”³è«‹ï¼›å–®æ—¥æ¨¡å¼ä¸‹ï¼Œæœ¬å€å¡Šå°‡ä¸ç”Ÿæ•ˆã€‚
                            </p>
                          </div>
                        </div>

                        <textarea id="purpose" rows="3" class="input-field" placeholder="ç”¨é€”èªªæ˜..."></textarea>
                    </div>

                    <div class="bg-rose-50 border border-rose-200 rounded-xl p-4">
                        <p id="safetyText" class="text-xs text-rose-600 mb-3 leading-relaxed">è«‹å…ˆé¸æ“‡å ´åœ°...</p>
                        <label class="flex items-start gap-2 cursor-pointer">
                          <input type="checkbox" id="safetyCheck" class="mt-1 w-4 h-4 text-rose-600 rounded" required>
                          <span class="text-xs text-rose-800 font-medium">æˆ‘å·²è©³é–±ä¸¦åŒæ„ä¸Šè¿°è¦ç¯„ã€‚</span>
                        </label>
                    </div>

                    <div class="flex gap-2">
                        <button type="button" id="cancelEditBtn" class="hidden w-1/3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200">å–æ¶ˆ</button>
                        <button type="submit" id="submitBtn" class="w-full rounded-xl bg-slate-900 text-white py-3.5 text-sm font-bold shadow-lg hover:bg-indigo-600 transition-all">
                          <i class="ri-send-plane-fill"></i> æäº¤ç”³è«‹
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="space-y-6">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
            <h3 class="font-bold text-slate-700 mb-3 text-sm uppercase tracking-wider">
              <i class="ri-calendar-2-line text-indigo-500"></i> æœªä¾† 7 å¤©æ¦‚æ³
            </h3>
            <div id="weeklyNotice" class="space-y-3 max-h-[200px] overflow-y-auto pr-1"></div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-1 overflow-hidden">
            <iframe id="calendarFrame" src="" style="border:0" width="100%" height="400" frameborder="0" scrolling="no"></iframe>
          </div>
        </div>
      </div>

      <!-- View: List -->
      <div id="view-list" class="max-w-6xl mx-auto hidden animate-fade-in">
         <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-[85vh]">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50/50">
               <h2 class="font-bold text-lg text-slate-700 flex items-center gap-2">
                 <i class="ri-file-list-3-line text-indigo-500"></i> é ç´„ç¸½è¡¨
               </h2>
               <input id="searchInput" type="text" placeholder="æœå°‹..." class="input-field py-1.5 text-sm w-40">
            </div>
            <div class="flex-1 overflow-auto p-4" id="bookingListContainer"></div>
         </div>
      </div>
    </div>
  </main>

  <!-- Modals & Toast -->
  <div id="cancelModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
      <h3 class="text-lg font-bold text-slate-800 mb-2">èº«åˆ†é©—è­‰</h3>
      <form id="cancelForm" class="space-y-3">
        <input type="hidden" id="cancelTargetId">
        <input type="hidden" id="cancelType">
        <input type="email" id="verifyEmail" class="input-field" placeholder="Email" required>
        <textarea id="cancelReason" class="input-field" rows="2" placeholder="å–æ¶ˆåŸå› " required></textarea>
        <div class="flex gap-2 pt-2">
          <button type="button" onclick="$('#cancelModal').classList.replace('flex','hidden')" class="flex-1 py-2 bg-gray-100 rounded-xl">é—œé–‰</button>
          <button type="submit" id="confirmCancelBtn" class="flex-1 py-2 bg-rose-600 text-white rounded-xl">é€å‡º</button>
        </div>
      </form>
    </div>
  </div>

  <div id="photoModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
      <h3 class="text-lg font-bold text-slate-800 mb-2">ä¸Šå‚³ç´€éŒ„ç…§ç‰‡</h3>
      <p class="text-xs text-slate-500 mb-4">å°‡è‡ªå‹•å£“ç¸®è‡³ 800px å¯¬ã€‚</p>
      <form id="photoForm" class="space-y-4">
        <input type="hidden" id="photoTargetId">
        <div class="grid grid-cols-3 gap-2">
          <label class="cursor-pointer border-2 border-slate-100 rounded-lg p-2 text-center hover:border-indigo-500 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
            <input type="radio" name="photoType" value="ä½¿ç”¨å‰" class="hidden" checked>
            <div class="text-xs font-bold">ä½¿ç”¨å‰</div>
          </label>
          <label class="cursor-pointer border-2 border-slate-100 rounded-lg p-2 text-center hover:border-indigo-500 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
            <input type="radio" name="photoType" value="ä½¿ç”¨ä¸­" class="hidden">
            <div class="text-xs font-bold">ä½¿ç”¨ä¸­</div>
          </label>
          <label class="cursor-pointer border-2 border-slate-100 rounded-lg p-2 text-center hover:border-indigo-500 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50">
            <input type="radio" name="photoType" value="æ­¸é‚„å¾Œ" class="hidden">
            <div class="text-xs font-bold">æ­¸é‚„å¾Œ</div>
          </label>
        </div>
        <input type="file" id="photoFile" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" required>
        <div id="photoPreview" class="w-full h-32 bg-slate-100 rounded-lg hidden bg-cover bg-center"></div>
        <div id="progressText" class="text-xs text-center text-indigo-600 hidden"></div>
        <button type="submit" id="uploadBtn" class="w-full py-2.5 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700">é–‹å§‹ä¸Šå‚³</button>
      </form>
      <button onclick="$('#photoModal').classList.replace('flex','hidden')" class="mt-2 w-full py-2 text-slate-400 text-sm hover:text-slate-600">å–æ¶ˆ</button>
    </div>
  </div>

  <div id="toast" class="fixed bottom-8 right-8 px-6 py-4 bg-slate-800 text-white rounded-xl shadow-2xl flex items-center gap-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
    <div id="toastIcon"></div>
    <div>
      <h4 id="toastTitle" class="font-bold text-sm"></h4>
      <p id="toastMsg" class="text-xs text-slate-300"></p>
    </div>
  </div>

<!-- ============================================== -->
<!-- âš ï¸ ä¿®æ­£å¾Œçš„è…³æœ¬æ”¾åœ¨é€™è£¡ï¼Œç¢ºä¿åœ¨æ‰€æœ‰ HTML å…ƒç´ ä¹‹å¾ŒåŸ·è¡Œ -->
<!-- ============================================== -->
<script>
  // ==================== å…¨åŸŸè¨­å®š ====================
  const $ = (s) => document.querySelector(s);
  let dbData = [];

  // â˜… å¡«å…¥ä½ çš„ Apps Script Web App URL
  const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzNHvMSEr768RIznOLJwdoybkRh-lE1iI9kZ57rSR0ElAh-CMjmyhk5UFz18d3Lbga_sQ/exec';
  // â˜… å¡«å…¥ä½ çš„ Google æ—¥æ›† embed URL
  const CALENDAR_EMBED_URL = 'https://calendar.google.com/calendar/embed?src=5d3470b8ffb11daa8db6817414d5eedacc728c0cde687d295a3b29e5e82214d1%40group.calendar.google.com&ctz=Asia%2FTaipei';

  // ==================== UUID ç”¢ç”Ÿå™¨ ====================
  // è§£æ±º crypto.randomUUID åœ¨é HTTPS ç’°å¢ƒå ±éŒ¯çš„å•é¡Œ
  function generateUUID() {
    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
      try { return crypto.randomUUID(); } catch(e) {}
    }
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  // ==================== å…±ç”¨ UI / åˆå§‹åŒ– ====================
  function toggleMobileSidebar() {
    const a = $('aside');
    if (!a) return;
    a.classList.toggle('hidden');
    a.classList.toggle('absolute');
    a.classList.toggle('h-full');
  }

  // åˆå§‹åŒ–æ—¥æ›†èˆ‡æ—¥æœŸ
  if ($('#calendarFrame')) $('#calendarFrame').src = CALENDAR_EMBED_URL;
  if ($('#date')) $('#date').value = new Date().toISOString().slice(0, 10);

  const SAFETY_HIGH = "âš ï¸ ä¾å…§æ”¿éƒ¨æ¶ˆé˜²ç½²109å¹´9æœˆ29æ—¥æ¶ˆç½²è¨“å­—ç¬¬1091700957è™Ÿå‡½é ’ã€Œæ¶ˆé˜²æ©Ÿé—œè¾¦ç†å„é …æ•‘ç½è¨“ç·´å®‰å…¨ç®¡ç†æŒ‡å°åŸå‰‡ã€è¾¦ç†ï¼Œè«‹æŒ‡æ´¾è³‡æ·±æ•™å®˜è² è²¬å…¨ç›¤è¨“ç·´å®‰å…¨äº‹å®œã€‚\nâš ï¸ å€Ÿç”¨å–®ä½è«‹æ–¼è¨“å¾Œå°‡å ´åœ°å¾©åŸä¸¦ç¶­æŒå ´åœ°æ•´æ½”ã€‚";
  const SAFETY_LOW = "âš ï¸ è«‹å€Ÿç”¨å–®ä½è¨“å¾Œå°‡å ´åœ°å¾©åŸä¸¦ç¶­æŒå ´åœ°æ•´æ½”ã€‚";

  // ==================== å ´åœ°é¸æ“‡ â†’ å®‰å…¨æ–‡å­— ====================
  const facilityEl = $('#facility');
  if (facilityEl) {
    facilityEl.addEventListener('change', (e) => {
      const val = e.target.value;
      const customInput = $('#customFacility');
      if (customInput) {
        if (val === 'other') {
          customInput.classList.remove('hidden');
          customInput.required = true;
        } else {
          customInput.classList.add('hidden');
          customInput.required = false;
          customInput.value = "";
        }
      }
      const isHigh = ["ç‡ƒç‡’æ«ƒ", "ç‡ƒç‡’å®¤", "ç©ºå‘¼æ°£è¨“ç·´å ´", "ABå¡”", "å¤§ç›´è¨“ç·´å ´"].includes(val) || val === 'other';
      const safetyTextEl = $('#safetyText');
      if (safetyTextEl) safetyTextEl.innerText = isHigh ? SAFETY_HIGH : SAFETY_LOW;
    });
  }
  if ($('#safetyText')) $('#safetyText').innerText = SAFETY_LOW;

  // ==================== å…¨å¤©å‹¾é¸ ====================
  const isAllDayEl = $('#isAllDay');
  if (isAllDayEl) {
    isAllDayEl.addEventListener('change', (e) => {
      const s = $('#startTime'), eEnd = $('#endTime');
      if (!s || !eEnd) return;
      if (e.target.checked) {
        s.value = "08:00";
        eEnd.value = "17:00";
        s.classList.add('disabled-input');
        eEnd.classList.add('disabled-input');
      } else {
        s.classList.remove('disabled-input');
        eEnd.classList.remove('disabled-input');
      }
    });
  }

  // ==================== ç”³è«‹æ¨¡å¼ï¼šå–®æ—¥ / å¤šæ—¥ ====================
  function updateApplyMode() {
    const modeInput = document.querySelector('input[name="applyMode"]:checked');
    const mode = modeInput ? modeInput.value : 'single';
    const singleRow = $('#singleDateRow');
    const multiWrap  = $('#multiDateWrap');
    const singleDate = $('#date');
    const dStart = $('#dateStart');
    const dEnd   = $('#dateEnd');

    if (!singleRow || !multiWrap) return;

    if (mode === 'single') {
      singleRow.classList.remove('hidden');
      multiWrap.classList.add('hidden');
      if (singleDate) singleDate.required = true;
      if (dStart) dStart.required = false;
      if (dEnd)   dEnd.required   = false;
    } else {
      singleRow.classList.add('hidden');
      multiWrap.classList.remove('hidden');
      if (singleDate) singleDate.required = false;
      if (dStart) dStart.required = true;
      if (dEnd)   dEnd.required   = true;
    }
  }

  const applyModeRadios = document.querySelectorAll('input[name="applyMode"]');
  if (applyModeRadios.length) {
    applyModeRadios.forEach(r => {
      r.addEventListener('change', updateApplyMode);
    });
    updateApplyMode();
  }

  // ==================== å¾ GAS æŠ“è³‡æ–™ ====================
  async function fetchData() {
    try {
      const res = await fetch(GAS_ENDPOINT);
      dbData = await res.json();
      updateWeeklyNotice();
      renderList();
      renderTodo();
      showToast('åŒæ­¥å®Œæˆ', 'è³‡æ–™å·²æ›´æ–°', 'success');
    } catch (e) {
      console.error(e);
      showToast('åŒæ­¥å¤±æ•—', 'ç„¡æ³•å–å¾—æœ€æ–°è³‡æ–™', 'error');
    }
  }

  const syncBtn = $('#syncBtn');
  if (syncBtn) syncBtn.onclick = fetchData;
  // è¼‰å…¥é é¢æ™‚è‡ªå‹•åŒæ­¥ä¸€æ¬¡
  fetchData();

  // ==================== Helperï¼šåˆ¤æ–·ç¼ºå“ªäº›ç…§ç‰‡ ====================
  function getMissingParts(statusStr) {
    const missing = [];
    if (!statusStr.includes('ä½¿ç”¨å‰')) missing.push('å‰');
    if (!statusStr.includes('ä½¿ç”¨ä¸­')) missing.push('ä¸­');
    if (!statusStr.includes('æ­¸é‚„å¾Œ')) missing.push('å¾Œ');
    return missing;
  }

  // ==================== å¾…è£œç…§ç‰‡æé†’å€å¡Š ====================
  function renderTodo() {
    const todoContainer = $('#todoList');
    const todoSection = $('#todoSection');
    const badge = $('#pendingBadge');
    if (!todoContainer || !todoSection || !badge) return;

    const today = new Date().toISOString().slice(0, 10);

    const pendingItems = dbData.filter(x => {
      if (!x.status.includes('å·²æ ¸å‡†')) return false;
      if (x.date > today) return false;
      const s = x.uploadStatus || "";
      return !(s.includes("ä½¿ç”¨å‰") && s.includes("ä½¿ç”¨ä¸­") && s.includes("æ­¸é‚„å¾Œ"));
    });

    if (pendingItems.length > 0) {
      badge.innerText = pendingItems.length;
      badge.classList.remove('hidden');
      todoSection.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
      todoSection.classList.add('hidden');
      return;
    }

    todoContainer.innerHTML = pendingItems.map(item => {
      const missing = getMissingParts(item.uploadStatus || "");
      const missingText = missing.join('ã€');
      return `
        <div class="flex items-center justify-between bg-white p-2.5 rounded-lg border border-rose-100 shadow-sm">
          <div class="flex flex-col">
            <div class="text-xs font-bold text-slate-700">${item.date} ${item.facility}</div>
            <div class="text-[10px] text-rose-600 font-bold">âŒ ç¼ºï¼š${missingText}</div>
          </div>
          <button onclick="switchView('list'); openPhotoModal('${item.id}')" class="text-xs bg-rose-600 text-white px-3 py-1.5 rounded-lg font-bold hover:bg-rose-700 shadow-md btn-alert">
            <i class="ri-camera-fill"></i> ä¸Šå‚³
          </button>
        </div>
      `;
    }).join('');
  }

  // ==================== è¿‘æœŸ 7 å¤©é ç´„è³‡è¨Š ====================
  function updateWeeklyNotice() {
    const con = $('#weeklyNotice');
    if (!con) return;
    con.innerHTML = '';
    let has = false;
    for (let i = 0; i < 7; i++) {
      const d = new Date();
      d.setDate(new Date().getDate() + i);
      const ds = d.toISOString().slice(0, 10);
      const books = dbData.filter(x => x.date === ds && x.status.includes('å·²æ ¸å‡†'));
      if (books.length) {
        has = true;
        con.innerHTML += `
          <div class="text-xs border-b border-slate-100 pb-2 last:border-0">
            <div class="font-bold text-indigo-600 mb-1">${ds}</div>
            ${books.map(b => `
              <div class="flex justify-between bg-slate-50 px-2 py-1 rounded text-slate-600">
                <span>${b.facility}</span>
                <span>${b.startTime}-${b.endTime}</span>
              </div>`).join('')}
          </div>`;
      }
    }
    if (!has) con.innerHTML = '<div class="text-sm text-slate-400 py-4 text-center">æœªä¾† 7 å¤©ç„¡æ ¸å‡†é ç´„</div>';
  }

  // ==================== è¡¨å–®é€å‡ºï¼ˆå–®æ—¥ / å¤šæ—¥ + æ‰¹æ¬¡å»ºç«‹ï¼‰ ====================
  const bookingForm = $('#bookingForm');
  if (bookingForm) {
    bookingForm.addEventListener('submit', async e => {
      e.preventDefault();

      const startTimeEl = $('#startTime');
      const endTimeEl = $('#endTime');

      // æ™‚é–“é˜²å‘†
      if (startTimeEl && endTimeEl && startTimeEl.value && endTimeEl.value) {
        if (endTimeEl.value <= startTimeEl.value) {
          alert('æ™‚é–“éŒ¯èª¤ï¼šçµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“');
          return;
        }
      }

      let facVal = facilityEl ? facilityEl.value : '';
      const customFacilityEl = $('#customFacility');
      if (facVal === 'other' && customFacilityEl) facVal = customFacilityEl.value.trim();
      if (!facVal) {
        alert('è«‹é¸æ“‡æˆ–è¼¸å…¥å ´åœ°');
        return;
      }

      const btn = $('#submitBtn');
      if (!btn) return;

      // é¿å…é‡è¤‡é»æ“Š
      if (btn.disabled) return;
      const originalBtnText = btn.innerHTML;
      btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> è™•ç†ä¸­...';
      btn.disabled = true;

      try {
        const isEdit = $('#editId') && $('#editId').value !== "";
        const base = {
          unit: $('#unit') ? $('#unit').value : '',
          contact: $('#contact') ? $('#contact').value : '',
          phone: $('#phone') ? $('#phone').value : '',
          email: $('#email') ? $('#email').value : '',
          facility: facVal,
          purpose: $('#purpose') ? $('#purpose').value : '',
          startTime: startTimeEl ? startTimeEl.value : '',
          endTime: endTimeEl ? endTimeEl.value : '',
          id: isEdit ? $('#editId').value : generateUUID()
        };

        if (isEdit) {
          await fetch(GAS_ENDPOINT, {
            method: 'POST',
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({ ...base, date: $('#date') ? $('#date').value : '', action: 'edit' })
          });
          showToast('æ›´æ–°æˆåŠŸ', 'å·²å„²å­˜è®Šæ›´', 'success');
          resetForm();
          setTimeout(fetchData, 1500);
        } else {
          // ç”³è«‹æ¨¡å¼ï¼šsingle = å–®æ—¥ã€multi = å¤šæ—¥
          const modeInput = document.querySelector('input[name="applyMode"]:checked');
          const applyMode = modeInput ? modeInput.value : 'single';
          let dates = [];

          if (applyMode === 'single') {
            const singleDateEl = $('#date');
            const singleDate = singleDateEl ? singleDateEl.value : '';
            if (!singleDate) throw new Error('è«‹å¡«å¯«å–®æ—¥æ—¥æœŸ');
            dates = [singleDate];
          } else {
            const dStartEl = $('#dateStart');
            const dEndEl   = $('#dateEnd');
            const modeSel  = $('#dateMode');

            const dStart = dStartEl ? dStartEl.value : '';
            const dEnd   = dEndEl ? dEndEl.value : '';
            const mode   = modeSel ? modeSel.value : 'all';

            if (!dStart || !dEnd) throw new Error('è«‹å¡«å¯«å¤šæ—¥èµ·è¨–æ—¥æœŸ');

            const start = new Date(dStart);
            const end   = new Date(dEnd);
            if (end < start) throw new Error('å¤šæ—¥å€é–“éŒ¯èª¤ï¼šçµæŸæ—¥æœŸéœ€æ™šæ–¼èµ·å§‹æ—¥æœŸ');

            let c = new Date(start);
            while (c <= end) {
              const day = c.getDay();
              let add = true;
              if (mode === 'weekday' && (day === 0 || day === 6)) add = false;
              if (mode === 'weekend' && (day !== 0 && day !== 6)) add = false;
              if (add) dates.push(c.toISOString().slice(0, 10));
              c.setDate(c.getDate() + 1);
            }
            if (!dates.length) throw new Error('å¤šæ—¥å€é–“å…§ç„¡æœ‰æ•ˆæ—¥æœŸï¼ˆå¯èƒ½å…¨éƒ¨è¢«æ’é™¤ç‚ºé€±æœ«æˆ–å¹³æ—¥ï¼‰');
          }

          // ç™¼é€è«‹æ±‚ï¼šæ‰¹æ¬¡å»ºç«‹
          await fetch(GAS_ENDPOINT, {
            method: 'POST',
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify({ ...base, dates: dates, action: 'create_batch' })
          });
          showToast('ç”³è«‹æˆåŠŸ', `å·²é€å‡º ${dates.length} ç­†ç´€éŒ„ï¼Œå¾…å¯©æ ¸ã€‚`, 'success');
          resetForm();
          setTimeout(fetchData, 1500);
        }
      } catch (err) {
        console.error(err);
        alert('æäº¤å¤±æ•—: ' + (err.message || 'æœªçŸ¥éŒ¯èª¤'));
        showToast('æäº¤å¤±æ•—', 'è«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡ç®¡ç†è€…', 'error');
      } finally {
        btn.innerHTML = originalBtnText;
        btn.classList.remove('bg-emerald-600');
        btn.classList.add('bg-slate-900');
        if ($('#editId') && $('#editId').value) {
          btn.innerHTML = "<i class='ri-save-line'></i> å„²å­˜è®Šæ›´";
          btn.classList.add('bg-emerald-600');
        } else {
          btn.innerHTML = "<i class='ri-send-plane-fill'></i> æäº¤ç”³è«‹";
        }
        btn.disabled = false;
      }
    });
  }

  // ==================== ç…§ç‰‡é è¦½ & ä¸Šå‚³ ====================
  const photoFileEl = $('#photoFile');
  if (photoFileEl) {
    photoFileEl.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e2) => {
          const preview = $('#photoPreview');
          if (!preview) return;
          preview.style.backgroundImage = `url(${e2.target.result})`;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });
  }

  window.openPhotoModal = (id) => {
    const targetId = $('#photoTargetId');
    const photoFile = $('#photoFile');
    const preview = $('#photoPreview');
    const progressText = $('#progressText');
    const modal = $('#photoModal');
    if (!targetId || !photoFile || !preview || !progressText || !modal) return;
    targetId.value = id;
    photoFile.value = '';
    preview.classList.add('hidden');
    progressText.classList.add('hidden');
    modal.classList.replace('hidden', 'flex');
  };

  const photoForm = $('#photoForm');
  if (photoForm) {
    photoForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = $('#photoFile');
      if (!fileInput) return;
      const file = fileInput.files[0];
      if (!file) return alert('è«‹é¸æ“‡ç…§ç‰‡');

      const btn = $('#uploadBtn');
      const pt = $('#progressText');
      if (!btn || !pt) return;

      btn.innerHTML = 'è™•ç†ä¸­...';
      btn.disabled = true;
      pt.textContent = 'æ­£åœ¨å£“ç¸®åœ–ç‰‡...';
      pt.classList.remove('hidden');

      try {
        const resized = await compressImage(file);
        const typeInput = document.querySelector('input[name="photoType"]:checked');
        const type = typeInput ? typeInput.value : 'ä½¿ç”¨å‰';
        pt.textContent = 'æ­£åœ¨ä¸Šå‚³è‡³é›²ç«¯...';

        const res = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify({
            action: 'upload_photo',
            id: $('#photoTargetId') ? $('#photoTargetId').value : '',
            fileData: resized.split(',')[1],
            mimeType: 'image/jpeg',
            photoType: type
          })
        });
        const result = await res.json();
        if (result.status === 'success') {
          showToast('ä¸Šå‚³æˆåŠŸ', 'ç…§ç‰‡å·²å­˜å…¥é›²ç«¯', 'success');
          const modal = $('#photoModal');
          if (modal) modal.classList.replace('flex', 'hidden');
          setTimeout(fetchData, 1500);
        } else {
          alert(result.message || 'ä¸Šå‚³å¤±æ•—');
        }
      } catch (err) {
        console.error(err);
        alert('ä¸Šå‚³éç¨‹ç™¼ç”ŸéŒ¯èª¤');
      } finally {
        btn.innerHTML = 'é–‹å§‹ä¸Šå‚³';
        btn.disabled = false;
        pt.classList.add('hidden');
      }
    });
  }

  function compressImage(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const scale = 800 / img.width;
          canvas.width = scale < 1 ? 800 : img.width;
          canvas.height = scale < 1 ? img.height * scale : img.height;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL('image/jpeg', 0.6));
        };
      };
    });
  }

  // ==================== ç·¨è¼¯ç´€éŒ„ ====================
  window.editRecord = (id) => {
    const r = dbData.find(x => x.id === id);
    if (!r) return;
    if ($('#editId')) $('#editId').value = r.id;
    if ($('#unit')) $('#unit').value = r.unit;
    if ($('#contact')) $('#contact').value = r.contact;
    if ($('#phone')) $('#phone').value = r.phone;
    if ($('#email')) $('#email').value = r.email;
    if ($('#facility')) $('#facility').value = r.facility;
    if ($('#purpose')) $('#purpose').value = r.purpose;
    if ($('#date')) $('#date').value = r.date;
    if ($('#startTime')) $('#startTime').value = r.startTime;
    if ($('#endTime')) $('#endTime').value = r.endTime;

    // ç·¨è¼¯ç‹€æ…‹å›ºå®šç”¨å–®æ—¥æ¨¡å¼
    const modeSingle = $('#modeSingle');
    const modeMulti  = $('#modeMulti');
    if (modeSingle) modeSingle.checked = true;
    if (modeMulti) modeMulti.checked = false;
    updateApplyMode();

    const formTitle = $('#formTitle');
    const submitBtn = $('#submitBtn');
    const cancelEditBtn = $('#cancelEditBtn');
    if (formTitle) formTitle.textContent = "ç·¨è¼¯é ç´„ç”³è«‹";
    if (submitBtn) {
      submitBtn.innerHTML = "<i class='ri-save-line'></i> å„²å­˜è®Šæ›´";
      submitBtn.classList.remove('bg-slate-900');
      submitBtn.classList.add('bg-emerald-600');
    }
    if (cancelEditBtn) cancelEditBtn.classList.remove('hidden');
    switchView('form');
  };

  const cancelEditBtnEl = $('#cancelEditBtn');
  if (cancelEditBtnEl) cancelEditBtnEl.onclick = resetForm;

  function resetForm() {
    const bookingForm = $('#bookingForm');
    if (bookingForm) bookingForm.reset();
    if ($('#editId')) $('#editId').value = "";
    if ($('#date')) $('#date').value = new Date().toISOString().slice(0, 10);
    if ($('#facility')) $('#facility').value = "";
    const customFacility = $('#customFacility');
    if (customFacility) customFacility.classList.add('hidden');
    const formTitle = $('#formTitle');
    const submitBtn = $('#submitBtn');
    const cancelEditBtn = $('#cancelEditBtn');
    if (formTitle) formTitle.textContent = "æ–°å¢é ç´„ç”³è«‹";
    if (submitBtn) {
      submitBtn.innerHTML = "<i class='ri-send-plane-fill'></i> æäº¤ç”³è«‹";
      submitBtn.classList.remove('bg-emerald-600');
      submitBtn.classList.add('bg-slate-900');
    }
    if (cancelEditBtn) cancelEditBtn.classList.add('hidden');
    if ($('#isAllDay')) $('#isAllDay').checked = false;
    if ($('#startTime')) $('#startTime').classList.remove('disabled-input');
    if ($('#endTime')) $('#endTime').classList.remove('disabled-input');
    if ($('#safetyText')) $('#safetyText').innerText = SAFETY_LOW;

    // é‡è¨­æ¨¡å¼ç‚ºå–®æ—¥
    const modeSingle = $('#modeSingle');
    const modeMulti  = $('#modeMulti');
    if (modeSingle) modeSingle.checked = true;
    if (modeMulti) modeMulti.checked = false;
    updateApplyMode();
  }

  // ==================== å–æ¶ˆç”³è«‹ï¼ˆå–®ä¸€ / æ•´æ‰¹ï¼‰ ====================
  window.openCancelModal = (id, isBatch) => {
    const targetId = $('#cancelTargetId');
    const typeEl = $('#cancelType');
    const verifyEmail = $('#verifyEmail');
    const cancelReason = $('#cancelReason');
    const modal = $('#cancelModal');
    if (!targetId || !typeEl || !verifyEmail || !cancelReason || !modal) return;
    targetId.value = id;
    typeEl.value = isBatch ? 'batch' : 'single';
    verifyEmail.value = '';
    cancelReason.value = '';
    modal.classList.replace('hidden', 'flex');
  };

  const cancelForm = $('#cancelForm');
  if (cancelForm) {
    cancelForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = $('#confirmCancelBtn');
      if (!btn) return;
      btn.innerHTML = 'é©—è­‰ä¸­...';
      btn.disabled = true;
      try {
        const typeEl = $('#cancelType');
        const isBatch = typeEl && typeEl.value === 'batch';
        const body = {
          action: isBatch ? 'cancel_batch' : 'cancel_request',
          [isBatch ? 'batchId' : 'id']: $('#cancelTargetId') ? $('#cancelTargetId').value : '',
          verifyEmail: $('#verifyEmail') ? $('#verifyEmail').value.trim() : '',
          reason: $('#cancelReason') ? $('#cancelReason').value.trim() : ''
        };
        const res = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(body)
        });
        const result = await res.json();
        if (result.status === 'success') {
          showToast('å·²é€å‡º', 'å–æ¶ˆç”³è«‹å·²é€äº¤ç®¡ç†è€…', 'success');
          const modal = $('#cancelModal');
          if (modal) modal.classList.replace('flex', 'hidden');
          setTimeout(fetchData, 1500);
        } else {
          alert(result.message || 'ç”³è«‹å¤±æ•—');
        }
      } catch (err) {
        console.error(err);
        showToast('éŒ¯èª¤', 'è«‹ç¨å¾Œå†è©¦', 'error');
      } finally {
        btn.innerHTML = 'é€å‡º';
        btn.disabled = false;
      }
    });
  }

  // ==================== åˆ—è¡¨æ¸²æŸ“ ====================
  function renderList() {
    const container = $('#bookingListContainer');
    if (!container) return;
    container.innerHTML = '';
    const searchInput = $('#searchInput');
    const filter = (searchInput ? searchInput.value : '').toLowerCase();
    let activeList = dbData.filter(x => !x.status.includes("å–æ¶ˆ") && !x.status.includes("æ‹’çµ•"));
    activeList = activeList.filter(x => (x.unit + x.contact + x.facility).toLowerCase().includes(filter));

    const groups = {};
    activeList.forEach(item => {
      const key = item.batchId || item.id;
      if (!groups[key]) groups[key] = [];
      groups[key].push(item);
    });

    const sortedKeys = Object.keys(groups).sort((a, b) => groups[a][0].date.localeCompare(groups[b][0].date));
    if (sortedKeys.length === 0) {
      container.innerHTML = '<div class="text-center text-slate-400 py-10">ç„¡è³‡æ–™</div>';
      return;
    }

    const today = new Date().toISOString().slice(0, 10);

    sortedKeys.forEach(key => {
      const items = groups[key];
      const f = items[0];
      const isMulti = items.length > 1;
      const color = f.status.includes("æ ¸å‡†") ? "text-emerald-600 bg-emerald-50" :
                    (f.status.includes("æ’æœŸ") ? "text-rose-600 bg-rose-50" : "text-amber-600 bg-amber-50");

      let missingPhotoInfo = '';
      if (f.status.includes("æ ¸å‡†") && f.date <= today) {
        const anyMissing = items.some(item => {
          const s = item.uploadStatus || "";
          return !(s.includes("ä½¿ç”¨å‰") && s.includes("ä½¿ç”¨ä¸­") && s.includes("æ­¸é‚„å¾Œ"));
        });
        if (anyMissing) {
          const missingParts = getMissingParts(items[0].uploadStatus || "");
          const missingText = missingParts.join('ã€');
          missingPhotoInfo = `
            <div class="ml-2 flex itemsä¸­å¿ƒ gap-2">
              <span class="text-xs text-rose-600 font-bold">å°šç¼º: ${missingText}</span>
              <button onclick="event.stopPropagation(); this.closest('.card-root').querySelector('.details-panel').classList.remove('hidden');" class="bg-rose-600 text-white text-xs px-2 py-1 rounded shadow btn-alert">
                <i class="ri-camera-fill"></i>
              </button>
            </div>`;
        }
      }

      const card = document.createElement('div');
      card.className = "card-root bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden mb-3";
      card.innerHTML = `
        <div class="p-4 flex items-center justify-between cursor-pointer bg-white hover:bg-gray-50" onclick="this.nextElementSibling.classList.toggle('hidden')">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full flex items-center justify-center ${color} font-bold">
              <i class="ri-calendar-check-line"></i>
            </div>
            <div>
              <div class="font-bold text-slate-800 flex items-center gap-2">
                ${f.unit} <span class="text-xs font-normal text-slate-500">(${f.contact})</span>
                ${missingPhotoInfo}
              </div>
              <div class="text-xs text-slate-500 mt-0.5">
                ${isMulti ? `<span class="bg-slate-100 px-1.5 py-0.5 rounded font-mono mr-1">å…±${items.length}å¤©</span>` : ''}
                ${f.date} Â· ${f.facility}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs font-bold px-2 py-1 rounded ${color}">${f.status.split(' ')[1] || f.status}</span>
            ${isMulti ? `<button onclick="event.stopPropagation(); openCancelModal('${f.batchId}', true)" class="text-rose-500 hover:bg-rose-50 p-1.5 rounded text-xs border border-rose-200"><i class="ri-close-circle-line"></i> æ•´æ‰¹å–æ¶ˆ</button>` : ''}
            <i class="ri-arrow-down-s-line text-slate-400"></i>
          </div>
        </div>
        <div class="details-panel hidden border-t border-slate-100 bg-slate-50 p-3 space-y-2">
          ${items.map(item => {
            const statusStr = item.uploadStatus || "";
            const isComplete = statusStr.includes("ä½¿ç”¨å‰") && statusStr.includes("ä½¿ç”¨ä¸­") && statusStr.includes("æ­¸é‚„å¾Œ");
            let photoBadge = '';
            let uploadBtnClass = "text-indigo-500 hover:bg-indigo-50 p-1 rounded";

            if (item.status.includes('æ ¸å‡†')) {
              if (item.date > today) photoBadge = `<span class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">æœªé–‹å§‹</span>`;
              else if (isComplete) photoBadge = `<span class="text-xs text-emerald-600 bg-emerald-100 px-1.5 py-0.5 rounded">â— å·²çµæ¡ˆ</span>`;
              else if (item.date === today) photoBadge = `<span class="text-xs text-amber-600 bg-amber-100 px-1.5 py-0.5 rounded">â— é€²è¡Œä¸­</span>`;
              else {
                photoBadge = `<span class="text-xs text-rose-600 bg-rose-100 px-1.5 py-0.5 rounded font-bold">â— ç¼ºä»¶</span>`;
                uploadBtnClass = "bg-rose-600 text-white p-1.5 rounded shadow btn-alert hover:bg-rose-700";
              }
            }

            return `
              <div class="flex flex-col gap-2 bg-white p-2 rounded border border-slate-200">
                <div class="flex items-center justify-between text-sm">
                  <div class="flex items-center gap-3">
                    <span class="font-mono text-slate-600">${item.date}</span>
                    <span class="font-mono font-bold text-indigo-600">${item.startTime}-${item.endTime}</span>
                    <span class="text-slate-500 text-xs">${item.status}</span>
                    ${photoBadge}
                  </div>
                  <div class="flex gap-2 items-center">
                    ${item.status.includes('æ ¸å‡†') ? `<button onclick="openPhotoModal('${item.id}')" class="${uploadBtnClass}" title="ä¸Šå‚³ç…§ç‰‡"><i class="ri-camera-line text-lg"></i>${!isComplete && item.date <= today ? '<span class="text-xs ml-1">ä¸Šå‚³</span>' : ''}</button>` : ''}
                    ${(item.status.includes('å¾…å¯©æ ¸') || item.status.includes('æ’æœŸ')) ? `<button onclick="editRecord('${item.id}')" class="text-indigo-500 hover:bg-indigo-50 p-1 rounded"><i class="ri-edit-line"></i></button>` : ''}
                    <button onclick="openCancelModal('${item.id}', false)" class="text-rose-500 hover:bg-rose-50 p-1 rounded"><i class="ri-close-circle-line"></i></button>
                  </div>
                </div>
                ${item.folderUrl ? `
                  <div class="text-xs flex items-center justify-between bg-slate-50 p-1 rounded">
                    <a href="${item.folderUrl}" target="_blank" class="text-blue-500 hover:underline flex items-center gap-1">
                      <i class="ri-folder-open-line"></i> é–‹å•Ÿç…§ç‰‡è³‡æ–™å¤¾
                    </a>
                    <span class="text-slate-400 text-[10px]">${item.uploadStatus || ''}</span>
                  </div>` : ''}
              </div>`;
          }).join('')}
        </div>`;
      container.appendChild(card);
    });
  }

  const searchInputEl = $('#searchInput');
  if (searchInputEl) searchInputEl.addEventListener('input', renderList);

  // ==================== åŒ¯å‡º CSV ====================
  const exportCsvBtn = $('#exportCsvBtn');
  if (exportCsvBtn) {
    exportCsvBtn.onclick = () => {
      if (!dbData.length) {
        alert('ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
        return;
      }
      const csv = '\ufeffç‹€æ…‹,æ—¥æœŸ,é–‹å§‹,çµæŸ,å ´åœ°,å–®ä½\n' +
        dbData.map(r => `${r.status},${r.date},${r.startTime},${r.endTime},"${r.facility}","${r.unit}"`).join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = 'Booking.csv';
      a.click();
    };
  }

  // ==================== Toast ====================
  function showToast(t, m, type) {
    const o = $('#toast');
    if (!o) return;
    const titleEl = $('#toastTitle');
    const msgEl = $('#toastMsg');
    const iconEl = $('#toastIcon');
    if (titleEl) titleEl.textContent = t;
    if (msgEl) msgEl.textContent = m;
    if (iconEl) iconEl.className = `text-2xl ri-${type === 'success' ? 'checkbox-circle-fill text-emerald-400' : 'error-warning-fill text-rose-400'}`;
    o.classList.remove('translate-y-20', 'opacity-0');
    setTimeout(() => o.classList.add('translate-y-20', 'opacity-0'), 3000);
  }

  // ==================== View åˆ‡æ› ====================
  window.switchView = (v) => {
    document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
    const target = $('#view-' + v);
    if (target) target.classList.remove('hidden');
  };
</script>
</body>
</html>
