<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>å ´åœ°å€Ÿç”¨ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  </style>
  <script>
    // âš ï¸ 1. è«‹æ›´æ–°ç‚ºæ‚¨çš„æ–° GAS ç¶²å€
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxKeO5t47sRsfie6OECIrl0sY-JhlCeUuRm4olj5dHEOcyFbq4ievHuIi4NJ6jm6QCQYA/exec";
    
    // âš ï¸ 2. æ—¥æ›†åµŒå…¥ç¶²å€
    const CALENDAR_EMBED_URL = "https://calendar.google.com/calendar/embed?src=02c213a0408b579568583642708285d69e8a9c62cb232cb3c1e7aa2d135d33d4%40group.calendar.google.com&ctz=Asia%2FTaipei"; 
  </script>
</head>
<body class="bg-slate-100 text-slate-800 h-screen overflow-hidden flex selection:bg-indigo-500 selection:text-white">

  <!-- Sidebar -->
  <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-2xl z-20">
    <div class="p-6 border-b border-slate-800 flex items-center gap-3">
      <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center shadow-lg shadow-indigo-500/50"><i class="ri-building-2-fill text-white"></i></div>
      <div><h1 class="font-bold text-lg tracking-wide">å ´åœ°é ç´„</h1><p class="text-xs text-slate-400">è¨“ç·´ä¸­å¿ƒå…§éƒ¨ç³»çµ±</p></div>
    </div>
    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <button onclick="switchView('form'); resetForm();" class="nav-btn w-full text-left px-4 py-3 rounded-xl bg-indigo-600/20 text-indigo-300 border border-indigo-500/30 flex items-center gap-3 hover:bg-indigo-600 hover:text-white transition"><i class="ri-add-circle-line text-xl"></i> æ–°å¢ç”³è«‹</button>
      <button onclick="switchView('list')" class="nav-btn w-full text-left px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition"><i class="ri-file-list-3-line text-xl"></i> é ç´„æ¸…å–®</button>
      <button id="exportCsvBtn" class="w-full text-left px-4 py-2.5 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white flex items-center gap-3 transition text-sm mt-4"><i class="ri-file-excel-line"></i> åŒ¯å‡ºå ±è¡¨</button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-slate-100">
    <header class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center z-20">
      <h1 class="font-bold text-slate-800 flex items-center gap-2"><i class="ri-building-2-fill text-indigo-600"></i> å ´åœ°é ç´„</h1>
      <button onclick="$('aside').classList.toggle('hidden'); $('aside').classList.toggle('absolute'); $('aside').classList.toggle('h-full');" class="text-slate-600 p-2"><i class="ri-menu-line text-xl"></i></button>
    </header>

    <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
      
      <!-- Form View -->
      <div id="view-form" class="max-w-7xl mx-auto animate-fade-in grid lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
          <div class="flex justify-between items-end">
            <div><h2 id="formTitle" class="text-2xl font-bold text-slate-800">æ–°å¢é ç´„ç”³è«‹</h2><p class="text-slate-500 text-sm mt-1">è«‹è©³é–±è¦ç¯„ï¼Œé€å‡ºå¾Œç³»çµ±å°‡è‡ªå‹•å¯„ä¿¡é€šçŸ¥ã€‚</p></div>
            <button id="syncBtn" class="text-sm text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg hover:bg-indigo-100 transition flex items-center gap-1"><i class="ri-refresh-line"></i> é‡æ–°åŒæ­¥</button>
          </div>

          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
            <div class="h-1 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
            <form id="bookingForm" class="p-6 md:p-8 space-y-6">
              <input type="hidden" id="editId">
              <div class="space-y-4">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider"><i class="ri-user-smile-line"></i> ç”³è«‹è³‡æ–™</h3>
                <div class="grid md:grid-cols-2 gap-4">
                  <input id="unit" type="text" class="input-field" placeholder="å€Ÿç”¨å–®ä½ *" required>
                  <input id="contact" type="text" class="input-field" placeholder="è¯çµ¡äººå§“å *" required>
                  <input id="phone" type="tel" class="input-field" placeholder="è¯çµ¡é›»è©± *" required>
                  <input id="email" type="email" class="input-field" placeholder="Email (æ¥æ”¶é€šçŸ¥ç”¨) *" required>
                </div>
              </div>
              <hr class="border-slate-100">
              <div class="space-y-4">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider"><i class="ri-map-pin-time-line"></i> å ´åœ°èˆ‡æ™‚é–“</h3>
                <!-- å ´åœ°é¸å–® -->
                <select id="facility" class="input-field" required>
                  <option value="" disabled selected>è«‹é¸æ“‡å ´åœ°...</option>
                  <optgroup label="æ•™å­¸å€åŸŸ"><option>æ•™å®¤701</option><option>æ•™å®¤702</option><option>æ•™å®¤703</option></optgroup>
                  <optgroup label="å¯¦é«”è¨“ç·´å ´"><option>ç©ºå‘¼æ°£è¨“ç·´å ´</option><option>ç‡ƒç‡’æ«ƒ</option><option>ç‡ƒç‡’å®¤</option><option>å¤§ç›´è¨“ç·´å ´</option><option>ABå¡”</option><option>å…¶ä»–å ´åœ°1</option><option>å…¶ä»–å ´åœ°2</option></optgroup>
                  <option value="other">âœï¸ å…¶ä»– (è‡ªå¡«)</option>
                </select>
                <!-- è‡ªå¡«å ´åœ°è¼¸å…¥æ¡† (é è¨­éš±è—) -->
                <input id="customFacility" type="text" class="input-field hidden" placeholder="è«‹è¼¸å…¥å ´åœ°åç¨±...">

                <!-- æ—¥æœŸèˆ‡æ™‚é–“ -->
                <div class="grid md:grid-cols-3 gap-4 items-start">
                  <div class="space-y-1"><input id="date" type="date" class="input-field" required></div>
                  <div class="col-span-2 space-y-2">
                    <div class="flex items-center gap-2 p-1 bg-slate-50 rounded border border-slate-200">
                      <input type="checkbox" id="isAllDay" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer">
                      <label for="isAllDay" class="text-sm text-slate-700 font-medium cursor-pointer select-none">å…¨å¤©å€Ÿç”¨ (08:00 - 17:00)</label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                      <input id="startTime" type="time" class="input-field" required>
                      <input id="endTime" type="time" class="input-field" required>
                    </div>
                  </div>
                </div>
                <textarea id="purpose" rows="3" class="input-field" placeholder="ç”¨é€”èªªæ˜..."></textarea>
              </div>
              
              <!-- æ‰¹æ¬¡ç™»è¨˜å·¥å…· (å¤šæ—¥) -->
              <details id="batchSection" class="group bg-slate-50 rounded-xl border border-slate-200 p-4">
                <summary class="flex cursor-pointer items-center justify-between font-medium text-slate-600 text-sm"><span class="flex items-center gap-2"><i class="ri-calendar-todo-fill"></i> å¤šæ—¥/é€£çºŒç”³è«‹</span><i class="ri-arrow-down-s-line group-open:rotate-180 transition"></i></summary>
                <div class="grid grid-cols-2 gap-3 mt-3 border-t border-slate-200 pt-3">
                  <div><label class="text-[10px] text-slate-400 font-bold">èµ·å§‹</label><input id="dateStart" type="date" class="input-field text-sm p-2"></div>
                  <div><label class="text-[10px] text-slate-400 font-bold">çµæŸ</label><input id="dateEnd" type="date" class="input-field text-sm p-2"></div>
                </div>
                <div class="mt-2">
                  <label class="text-[10px] text-slate-400 font-bold">æ—¥æœŸæ¨¡å¼</label>
                  <select id="dateMode" class="input-field text-sm py-1">
                    <option value="all">é€£çºŒæ—¥æœŸ (å«å…­æ—¥)</option>
                    <option value="weekday">æ’é™¤é€±æœ« (åƒ…å¹³æ—¥)</option>
                    <option value="weekend">åƒ…é™é€±æœ« (åƒ…å…­æ—¥)</option>
                  </select>
                </div>
              </details>

              <!-- å®‰å…¨é ˆçŸ¥ (å¼·åˆ¶å‹¾é¸) -->
              <div class="bg-rose-50 border border-rose-200 rounded-xl p-4">
                <h4 class="text-sm font-bold text-rose-700 mb-2 flex items-center gap-2"><i class="ri-alarm-warning-line"></i> å€Ÿç”¨è¦ç¯„èˆ‡å®‰å…¨é ˆçŸ¥</h4>
                <p id="safetyText" class="text-xs text-rose-600 mb-3 leading-relaxed">è«‹å…ˆé¸æ“‡å ´åœ°ä»¥æª¢è¦–ç›¸é—œè¦ç¯„...</p>
                <label class="flex items-start gap-2 cursor-pointer">
                  <input type="checkbox" id="safetyCheck" class="mt-1 w-4 h-4 text-rose-600 rounded border-rose-300 focus:ring-rose-500" required>
                  <span class="text-xs text-rose-800 font-medium">æˆ‘å·²è©³é–±ä¸¦åŒæ„ä¸Šè¿°è¦ç¯„ï¼Œä¸”é¡˜æ„è² èµ·å ´åœ°å¾©åŸåŠå®‰å…¨ç®¡ç†ä¹‹è²¬ã€‚</span>
                </label>
              </div>

              <div class="flex gap-2">
                <button type="button" id="cancelEditBtn" class="hidden w-1/3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200">å–æ¶ˆç·¨è¼¯</button>
                <button type="submit" id="submitBtn" class="w-full rounded-xl bg-slate-900 text-white py-3.5 text-sm font-bold shadow-lg hover:bg-indigo-600 transition-all flex items-center justify-center gap-2"><i class="ri-send-plane-fill"></i> æäº¤ç”³è«‹</button>
              </div>
            </form>
          </div>
        </div>

        <div class="space-y-6">
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
             <h3 class="font-bold text-slate-700 mb-3 text-sm uppercase tracking-wider flex items-center gap-2"><i class="ri-calendar-2-line text-indigo-500"></i> æœªä¾† 7 å¤©æ¦‚æ³</h3>
             <div id="weeklyNotice" class="space-y-3 max-h-[200px] overflow-y-auto pr-1"><div class="text-sm text-slate-400 italic flex items-center gap-2"><i class="ri-loader-4-line animate-spin"></i> è®€å–ä¸­...</div></div>
          </div>
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-1 overflow-hidden">
            <iframe id="calendarFrame" src="" style="border:0" width="100%" height="400" frameborder="0" scrolling="no"></iframe>
          </div>
        </div>
      </div>

      <!-- List View -->
      <div id="view-list" class="max-w-6xl mx-auto hidden animate-fade-in">
         <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col h-[85vh]">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50/50">
               <h2 class="font-bold text-lg text-slate-700 flex items-center gap-2"><i class="ri-file-list-3-line text-indigo-500"></i> é ç´„ç¸½è¡¨</h2>
               <input id="searchInput" type="text" placeholder="æœå°‹..." class="input-field py-1.5 text-sm w-40">
            </div>
            <div class="flex-1 overflow-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 font-semibold sticky top-0 shadow-sm z-10"><tr><th class="p-4">ç‹€æ…‹</th><th class="p-4">æ—¥æœŸ</th><th class="p-4">æ™‚é–“</th><th class="p-4">å ´åœ°</th><th class="p-4">å–®ä½</th><th class="p-4 w-28 text-center">æ“ä½œ</th></tr></thead><tbody id="bookingTbody" class="divide-y divide-slate-100"></tbody></table></div>
         </div>
      </div>
    </div>
  </main>

  <!-- å–æ¶ˆé©—è­‰ Modal -->
  <div id="cancelModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-transform">
      <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2"><i class="ri-shield-keyhole-line text-indigo-600"></i> èº«åˆ†é©—è­‰</h3>
      <p class="text-sm text-slate-500 mb-4">è«‹è¼¸å…¥ç”³è«‹æ™‚çš„ Email ä»¥ç¢ºèªèº«åˆ†ã€‚</p>
      <form id="cancelForm" class="space-y-3">
        <input type="hidden" id="cancelTargetId">
        <div><label class="text-xs font-bold text-slate-400">é©—è­‰ Email *</label><input type="email" id="verifyEmail" class="input-field" placeholder="example@gmail.com" required></div>
        <div><label class="text-xs font-bold text-slate-400">å–æ¶ˆåŸå›  *</label><textarea id="cancelReason" class="input-field" rows="2" placeholder="ä¾‹å¦‚ï¼šè¡Œç¨‹è®Šæ›´..." required></textarea></div>
        <div class="flex gap-2 pt-2">
          <button type="button" onclick="$('#cancelModal').classList.replace('flex','hidden')" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl font-medium hover:bg-gray-200">é—œé–‰</button>
          <button type="submit" id="confirmCancelBtn" class="flex-1 py-2 bg-rose-600 text-white rounded-xl font-bold hover:bg-rose-700 shadow-lg shadow-rose-200">é€å‡ºç”³è«‹</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="fixed bottom-8 right-8 px-6 py-4 bg-slate-800 text-white rounded-xl shadow-2xl flex items-center gap-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50"><div id="toastIcon"></div><div><h4 id="toastTitle" class="font-bold text-sm"></h4><p id="toastMsg" class="text-xs text-slate-300"></p></div></div>
  <style>.input-field { width: 100%; border-radius: 0.5rem; border: 1px solid #e2e8f0; padding: 0.6rem; font-size: 0.875rem; transition: all 0.2s; } .input-field:focus { border-color: #6366f1; outline: 2px solid #e0e7ff; } .disabled-input { background-color: #f3f4f6; color: #9ca3af; pointer-events: none; }</style>

  <script>
    const $ = (s) => document.querySelector(s);
    let dbData = []; 
    $('#calendarFrame').src = CALENDAR_EMBED_URL;
    const today = new Date().toISOString().slice(0,10);
    $('#date').value = today;
    fetchData();

    // --- 1. å ´åœ°è®Šæ›´é‚è¼¯ (è‡ªå¡« & å®‰å…¨é ˆçŸ¥) ---
    const SAFETY_HIGH = "âš ï¸ ä¾å…§æ”¿éƒ¨æ¶ˆé˜²ç½²109å¹´9æœˆ29æ—¥æ¶ˆç½²è¨“å­—ç¬¬1091700957è™Ÿå‡½é ’ã€Œæ¶ˆé˜²æ©Ÿé—œè¾¦ç†å„é …æ•‘ç½è¨“ç·´å®‰å…¨ç®¡ç†æŒ‡å°åŸå‰‡ã€è¾¦ç†ï¼Œè«‹æŒ‡æ´¾è³‡æ·±æ•™å®˜è² è²¬å…¨ç›¤è¨“ç·´å®‰å…¨äº‹å®œã€‚\nâš ï¸ å€Ÿç”¨å–®ä½è«‹æ–¼è¨“å¾Œå°‡å ´åœ°å¾©åŸä¸¦ç¶­æŒå ´åœ°æ•´æ½”ã€‚";
    const SAFETY_LOW = "âš ï¸ è«‹å€Ÿç”¨å–®ä½è¨“å¾Œå°‡å ´åœ°å¾©åŸä¸¦ç¶­æŒå ´åœ°æ•´æ½”ã€‚";
    
    $('#facility').addEventListener('change', (e) => {
      const val = e.target.value;
      const customInput = $('#customFacility');
      
      // è‡ªå¡«å ´åœ°é¡¯ç¤º
      if(val === 'other') { customInput.classList.remove('hidden'); customInput.required = true; } 
      else { customInput.classList.add('hidden'); customInput.required = false; }

      // å®‰å…¨é ˆçŸ¥åˆ‡æ›
      const highRisk = ["ç‡ƒç‡’æ«ƒ", "ç‡ƒç‡’å®¤", "ç©ºå‘¼æ°£è¨“ç·´å ´", "ABå¡”", "å¤§ç›´è¨“ç·´å ´"];
      const isHigh = highRisk.includes(val) || (val === 'other'); // è‡ªå¡«å ´åœ°ä¹Ÿé è¨­é«˜é¢¨éšª
      $('#safetyText').innerText = isHigh ? SAFETY_HIGH : SAFETY_LOW;
    });
    // è§¸ç™¼ä¸€æ¬¡åˆå§‹åŒ–æ–‡å­—
    $('#safetyText').innerText = SAFETY_LOW;

    // --- 2. å…¨å¤©æŒ‰éˆ•é‚è¼¯ ---
    $('#isAllDay').addEventListener('change', (e) => {
      const s = $('#startTime'), eEnd = $('#endTime');
      if(e.target.checked) { s.value="08:00"; eEnd.value="17:00"; s.classList.add('disabled-input'); eEnd.classList.add('disabled-input'); }
      else { s.classList.remove('disabled-input'); eEnd.classList.remove('disabled-input'); }
    });

    async function fetchData() {
       try { const res = await fetch(GAS_ENDPOINT); dbData = await res.json(); updateWeeklyNotice(); renderList(); showToast('åŒæ­¥å®Œæˆ','è³‡æ–™å·²æ›´æ–°','success'); } catch(e){}
    }
    $('#syncBtn').onclick = fetchData;

    function updateWeeklyNotice() {
      const con = $('#weeklyNotice'); con.innerHTML='';
      const today=new Date(); let has=false;
      for(let i=0;i<7;i++){
        const d=new Date(); d.setDate(today.getDate()+i); const ds=d.toISOString().slice(0,10);
        const books=dbData.filter(x=>x.date===ds&&x.status.includes('å·²æ ¸å‡†'));
        if(books.length){ has=true; con.innerHTML+=`<div class="text-xs border-b border-slate-100 pb-2 last:border-0"><div class="font-bold text-indigo-600 mb-1">${ds}</div>${books.map(b=>`<div class="flex justify-between bg-slate-50 px-2 py-1 rounded text-slate-600"><span>${b.facility}</span><span>${b.startTime}-${b.endTime}</span></div>`).join('')}</div>`; }
      }
      if(!has) con.innerHTML='<div class="text-sm text-slate-400 py-4 text-center">æœªä¾† 7 å¤©ç„¡æ ¸å‡†é ç´„</div>';
    }

    // --- 3. æäº¤è¡¨å–® (å«æ‰¹æ¬¡æ‰“åŒ…) ---
    $('#bookingForm').addEventListener('submit', async e => {
      e.preventDefault();
      if($('#endTime').value <= $('#startTime').value) { alert('æ™‚é–“éŒ¯èª¤'); return; }
      
      // å–å¾—å ´åœ°åç¨±
      let facilityName = $('#facility').value;
      if(facilityName === 'other') facilityName = $('#customFacility').value.trim();
      if(!facilityName) { alert('è«‹è¼¸å…¥å ´åœ°åç¨±'); return; }

      const isEdit = $('#editId').value !== "";
      const baseData = {
        unit:$('#unit').value, contact:$('#contact').value, phone:$('#phone').value, email:$('#email').value,
        facility:facilityName, purpose:$('#purpose').value, startTime:$('#startTime').value, endTime:$('#endTime').value,
        id: isEdit ? $('#editId').value : crypto.randomUUID()
      };

      $('#submitBtn').innerHTML = '<i class="ri-loader-4-line animate-spin"></i> è™•ç†ä¸­...';

      if (isEdit) {
        // ç·¨è¼¯æ¨¡å¼ (å–®ç­†)
        await fetch(GAS_ENDPOINT, {method:'POST', headers: {"Content-Type": "text/plain"}, body:JSON.stringify({...baseData, date:$('#date').value, action:'edit'})});
        showToast('æ›´æ–°æˆåŠŸ','è³‡æ–™å·²ä¿®æ­£','success');
        resetForm();
      } else {
        // æ–°å¢æ¨¡å¼ (æ‰¹æ¬¡æ‰“åŒ…)
        const dStart=$('#dateStart').value, dEnd=$('#dateEnd').value, mode=$('#dateMode').value;
        let dates=[$('#date').value]; // é è¨­å–®æ—¥
        
        // å¦‚æœæœ‰å¡«æ‰¹æ¬¡æ—¥æœŸ
        if(dStart && dEnd) {
          dates = []; 
          let curr = new Date(dStart), end = new Date(dEnd);
          while(curr <= end) {
             const day = curr.getDay();
             // æ—¥æœŸéæ¿¾é‚è¼¯
             let add = true;
             if (mode === 'weekday' && (day===0 || day===6)) add = false;
             if (mode === 'weekend' && (day!==0 && day!==6)) add = false;
             
             if(add) dates.push(curr.toISOString().slice(0,10));
             curr.setDate(curr.getDate()+1);
          }
        }

        if(dates.length === 0) { alert('æ‰€é¸å€é–“ç„¡ç¬¦åˆæ—¥æœŸçš„å¤©æ•¸'); $('#submitBtn').innerHTML='æäº¤ç”³è«‹'; return; }

        // ğŸš€ æ‰“åŒ…é€å‡º (create_batch)
        await fetch(GAS_ENDPOINT, {
          method:'POST', 
          headers: {"Content-Type": "text/plain"}, 
          body:JSON.stringify({...baseData, dates: dates, action:'create_batch'})
        });
        
        showToast('ç”³è«‹æˆåŠŸ',`å·²é€å‡º ${dates.length} ç­†ç”³è«‹`,'success');
        resetForm();
      }
      setTimeout(fetchData, 2500);
      $('#submitBtn').innerHTML = 'æäº¤ç”³è«‹';
    });

    window.editRecord = (id) => {
      const r = dbData.find(x => x.id === id);
      if(!r) return;
      $('#editId').value = r.id;
      $('#unit').value = r.unit; $('#contact').value = r.contact; $('#phone').value = r.phone; $('#email').value = r.email;
      $('#facility').value = r.facility; $('#purpose').value = r.purpose; $('#date').value = r.date; 
      $('#startTime').value = r.startTime; $('#endTime').value = r.endTime;
      
      // ç·¨è¼¯ä¸æ”¯æ´æ‰¹æ¬¡ï¼Œéš±è—æ‰¹æ¬¡å€
      $('#batchSection').classList.add('hidden');
      $('#formTitle').textContent = "ç·¨è¼¯é ç´„ç”³è«‹";
      $('#submitBtn').innerHTML = "<i class='ri-save-line'></i> å„²å­˜è®Šæ›´";
      $('#submitBtn').classList.replace('bg-slate-900', 'bg-emerald-600');
      $('#cancelEditBtn').classList.remove('hidden');
      switchView('form');
    };

    $('#cancelEditBtn').onclick = resetForm;

    function resetForm() {
      $('#bookingForm').reset();
      $('#editId').value = "";
      $('#date').value = new Date().toISOString().slice(0,10);
      $('#facility').value = ""; // Reset select
      $('#customFacility').classList.add('hidden');
      
      $('#formTitle').textContent = "æ–°å¢é ç´„ç”³è«‹";
      $('#submitBtn').innerHTML = "<i class='ri-send-plane-fill'></i> æäº¤ç”³è«‹";
      $('#submitBtn').classList.replace('bg-emerald-600', 'bg-slate-900');
      $('#cancelEditBtn').classList.add('hidden');
      $('#batchSection').classList.remove('hidden');
      $('#isAllDay').checked = false;
      $('#startTime').classList.remove('disabled-input'); $('#startTime').readOnly = false;
      $('#endTime').classList.remove('disabled-input'); $('#endTime').readOnly = false;
      $('#safetyText').innerText = SAFETY_LOW; // Reset text
    }

    window.openCancelModal = (id) => {
      $('#cancelTargetId').value = id;
      $('#verifyEmail').value = '';
      $('#cancelReason').value = '';
      $('#cancelModal').classList.replace('hidden','flex');
    };

    $('#cancelForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = $('#cancelTargetId').value;
      const email = $('#verifyEmail').value.trim();
      const reason = $('#cancelReason').value.trim();
      const btn = $('#confirmCancelBtn');
      
      btn.innerHTML = '<i class="ri-loader-4-line animate-spin"></i> é©—è­‰ä¸­...';
      try {
        const res = await fetch(GAS_ENDPOINT, {
          method: 'POST', headers: {"Content-Type": "text/plain"},
          body: JSON.stringify({ action:'cancel_request', id:id, verifyEmail:email, reason:reason })
        });
        const result = await res.json();
        if (result.status === 'success') {
           showToast('è«‹æ±‚å·²é€å‡º', 'é©—è­‰æˆåŠŸï¼Œè«‹ç­‰å¾…å¯©æ ¸', 'success');
           $('#cancelModal').classList.replace('flex','hidden');
           setTimeout(fetchData, 1500);
        } else {
           alert(result.message || 'é©—è­‰å¤±æ•—');
        }
      } catch(err){ showToast('é€£ç·šéŒ¯èª¤','è«‹ç¨å¾Œå†è©¦','error'); }
      finally { btn.innerHTML = 'é€å‡ºç”³è«‹'; }
    });

    function renderList() {
      const tbody = $('#bookingTbody'); tbody.innerHTML='';
      const filter=$('#searchInput').value.toLowerCase();
      const list=dbData.filter(x=>(x.unit+x.contact+x.facility).toLowerCase().includes(filter)).sort((a,b)=>(b.date+b.startTime).localeCompare(a.date+a.startTime));
      if(!list.length){ tbody.innerHTML='<tr><td colspan="6" class="p-8 text-center text-slate-400">ç„¡è³‡æ–™</td></tr>'; return; }
      
      list.forEach(x => {
        let badge='bg-amber-100 text-amber-700';
        if(x.status.includes('å·²æ ¸å‡†')) badge='bg-emerald-100 text-emerald-700';
        if(x.status.includes('æ’æœŸ')) badge='bg-rose-100 text-rose-700 font-bold';
        if(x.status.includes('å–æ¶ˆ')||x.status.includes('æ‹’çµ•')) badge='bg-gray-100 text-gray-500 line-through';
        if(x.status.includes('ç”³è«‹å–æ¶ˆ')) badge='bg-orange-100 text-orange-700';
        
        const isPending = x.status.includes('å¾…å¯©æ ¸') || x.status.includes('æ’æœŸ');
        const canCancel = !x.status.includes('å–æ¶ˆ') && !x.status.includes('æ‹’çµ•');

        tbody.innerHTML+=`<tr class="hover:bg-slate-50 border-b border-slate-100">
          <td class="p-4"><span class="px-2 py-1 rounded text-xs ${badge}">${x.status}</span></td>
          <td class="p-4 font-mono">${x.date}</td><td class="p-4 font-mono font-bold">${x.startTime}-${x.endTime}</td>
          <td class="p-4">${x.facility}</td><td class="p-4 text-xs text-slate-500">${x.unit}<br>${x.contact}</td>
          <td class="p-4 text-center flex justify-center gap-2">
            ${isPending ? `<button onclick="editRecord('${x.id}')" class="text-indigo-500 hover:bg-indigo-50 p-1 rounded" title="ç·¨è¼¯"><i class="ri-edit-line text-lg"></i></button>` : ''}
            ${canCancel ? `<button onclick="openCancelModal('${x.id}')" class="text-rose-500 hover:bg-rose-50 p-1 rounded" title="ç”³è«‹å–æ¶ˆ"><i class="ri-close-circle-line text-lg"></i></button>` : ''}
          </td>
        </tr>`;
      });
    }
    $('#searchInput').addEventListener('input', renderList);
    $('#exportCsvBtn').onclick = () => {
       if(!dbData.length) return; const csv='\ufeffç‹€æ…‹,æ—¥æœŸ,é–‹å§‹,çµæŸ,å ´åœ°,å–®ä½\n'+dbData.map(r=>`${r.status},${r.date},${r.startTime},${r.endTime},"${r.facility}","${r.unit}"`).join('\n');
       const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='Booking.csv'; a.click();
    };
    function showToast(t,m,type){ const o=$('#toast'); $('#toastTitle').textContent=t; $('#toastMsg').textContent=m; $('#toastIcon').className=`text-2xl ri-${type==='success'?'checkbox-circle-fill text-emerald-400':'error-warning-fill text-rose-400'}`; o.classList.remove('translate-y-20','opacity-0'); setTimeout(()=>o.classList.add('translate-y-20','opacity-0'),3000); }
    window.switchView=(v)=>{ document.querySelectorAll('[id^="view-"]').forEach(e=>e.classList.add('hidden')); $('#view-'+v).classList.remove('hidden'); };
  </script>
</body>
</html>
